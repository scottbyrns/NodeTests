<!-- 
TODO

Send session id to server from client in each request.
 -->
<!doctype html>
<html>
	<head>
<script src="http://8199e9cd4b9d4126c6bd-4025f02f6818598207bd2390fe63160a.r10.cf1.rackcdn.com/jquery.min.js"></script>
	<script src="http://8199e9cd4b9d4126c6bd-4025f02f6818598207bd2390fe63160a.r10.cf1.rackcdn.com/joint.all.min.js"></script>
<link href="//fonts.googleapis.com/css?family=Open+Sans:300,400,600,700&amp;subset=latin" rel="stylesheet" />
                </script>
                <script src="http://166.78.180.166:9374/socket.io/socket.io.js"></script>
	

		<script>
		
		// Foundation - Distributed asyncronous aspect oriented run time enviornment.
		// Node - Pub/Sub aspect client linking.
		// LiveSpace - Distributed aspect oriented execution enviornment.
		
		window.CLIENT_TALKS = false;
		
		if (!Function.prototype.bind) {
		  Function.prototype.bind = function (oThis) {
		    if (typeof this !== "function") {
		      // closest thing possible to the ECMAScript 5 internal IsCallable function
		      throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");
		    }
 
		    var aArgs = Array.prototype.slice.call(arguments, 1), 
		        fToBind = this, 
		        fNOP = function () {},
		        fBound = function () {
		          return fToBind.apply(this instanceof fNOP && oThis
		                                 ? this
		                                 : oThis,
		                               aArgs.concat(Array.prototype.slice.call(arguments)));
		        };
 
		    fNOP.prototype = this.prototype;
		    fBound.prototype = new fNOP();
 
		    return fBound;
		  };
		}
	
		JSON.toList = function (array, scope, group, omit) {
			var list = "";
			scope = scope || "";
			
			list += "<legend>" + scope + "</legend>";
			
			list += "<ul>";
			
			for (var i = 0; i < array.length; i += 1) {
				list += "<li>";
				
				if (i == 0) {
					for (var element in array[i]) {
						if (array[i].hasOwnProperty(element)) {
							
						}
					}
				}
				
				list += JSON.toForm(array[i], scope, group, omit);
				
				list += "</li>";
			}
			
			list += "</ul>";
			
			return list;
		};
		
		JSON.stripNull = function (json) {
			if (json instanceof Array) {
				
			}
			else {
				for (var element in json) {
					if (json[element] == null) {
						json[element] = "";
					}
				}
			}
			
			return json;
		}
		
		JSON.toTable = function (array, scope, group, omit) {
			var table = "";
			scope = scope || "";
			// scope += ".";
			
			table += "<legend>" + scope + "</legend>";
			
			table += "<table cellspacing=\"5\">";
			table += "<thead>";
			table += "<tr>";
			
			if (typeof array[0] === "string" || typeof array[0] === "number") {
				table += "<th>";
				table += array[0];
				table += "</th>";
			}
			else if (typeof array[0] === "boolean") {
				table += "<th>";
				table += (array[0] ? "yes" : "no");
				table += "</th>";
			}
			else if (typeof array[0] === "object" && array[0] instanceof Array) {
				table += "<th>";
				table += JSON.toTable(array[0], scope, group, omit);
				table += "</th>";
			}
			else {
				// table += "<th>";
				// table += "<table>";
				// table += "<tr>";
				for (var element in array[0]) {
					if (omit.indexOf(element) > -1) {
						continue;
					}
					table += "<th>";
					table += element;
					table += "</th>";
				}
				// table += "</tr>";
				// table += "</table>";
				// table += "</th>";
			}
			// else {
			// 	table += "<th>";
			// 	table += JSON.toForm(array[0], scope);
			// 	table += "</th>";
			// }
			
			
			table += "</tr>";
			table += "</thead>";
			table += "<tbody>";
			
			for (var i = 0; i < array.length; i += 1) {
				
				table += "<tr>";
				
				array[i] = JSON.stripNull(array[i]);
				
				if (typeof array[i] === "string") {
					table += "<td>" + array[i] + "</td>";
				}
				else {
					for (var element in array[i]) {
						if (omit.indexOf(element) > -1) {
							continue;
						}
						table += "<td>";
					
						var child = array[i][element];
					
						if (typeof child === "string" || typeof child === "number") {
							table += child;
						}
						else if (typeof child === "boolean") {
							table += (child ? "yes" : "no");
						}
						else if (typeof child === "object" && child instanceof Array) {
							table += JSON.toTable(child, scope + "." + element, group, omit);
						}
						else {
							table += "<fieldset>";
							table += JSON.toForm(child, scope + "." + element, group, omit);
							table += "</fieldset>";
						}
					
						table += "</td>";
				
					}
				}
				


				
				table += "</tr>";
				
			}
			
			table += "</tbody>";
			table += "<tfoot>";
			
			table += "<tfoot>";
			table += "</table>";
			
			return table;
		};

		JSON.toForm = function (json, scope, group, omit) {
			json = JSON.stripNull(json);
			var form = "";
			scope = scope || "";
			group = group || scope;
			omit = omit || [];
			
			scope += ".";

			if (typeof json === "string" || typeof json === "number") {
				return json;
			}
			else if (typeof json == "boolean") {
				return json;
			}
			else if (typeof json === "object" && json instanceof Array) {
				return JSON.toList(json, scope, group, omit);
			}
			else {

			
				form += "<legend>" + scope + "</legend>";

				for (var element in json) {
					if (omit.indexOf(element) > -1) {
						continue;
					}
					if (json.hasOwnProperty(element)) {
						if (typeof json[element] === "string" || typeof json[element] === "number") {
							form += "<div>";
							form += "<label>" + element + "</label>";
							form += "<input data-widget=\"user-input\" data-type=\"string\" data-group=\"" + group + "\" data-channel=\"" + element + "\" data-omit-label=\"true\" type=\"text\" name=\"" + scope + element + "\" value=\"" + json[element] + "\" />\n";
							form += "</div>";
						}
						else if (typeof json[element] === "boolean") {
							form += "<div>";
							form += "<label>" + element + "</label>";
							form += "<input type=\"checkbox\" name=\"" + scope + element + "\" value=\"" + json[element] + "\" />\n"
							form += "</div>";
						}
						else if (typeof json[element] && json[element] instanceof Array) {
							form += "<fieldset>";
							// form += "<legend>" + element + "</legend>";
							form += JSON.toList(json[element], scope + element + ".", group, omit);
							form += "</fieldset>";						
						}
						else {
							form += "<fieldset>";
							form += JSON.toForm(json[element], scope + element, group, omit);
							form += "</fieldset>";
						}
					}
				}
				
				
				
			}
			
			return form;
		};
		

		(function (className, namespace) {
			if (typeof namespace === 'string' && !window[namespace]) {
				window[namespace] = {};
			}
			else if (typeof namespace === 'string' && window[namespace] && typeof className === 'string' && window[namespace][className]) {
				return;
			}
			namespace = namespace || 'window';
			/**
			 * Message controller constructor.
			 * @constructor
			 * @returns instance
			 */
			var MessageController = function () {
				/**
				 * Object to store the message handlers.
				 * @property
				 */
				this.messagePool = {};
				/**
				 * Unique ID counter
				 * @property
				 */
				this.currentUID = 0;
			};
			/**
			 * Prototype of the MessageController class
			 */
			MessageController.prototype = {
				/**
				 * Add an event listener
				 * @param {String} group Listener group to add the callback to.
				 * @param {Function} callback callback to register to a listener group.
				 */
				addListener: function (group, callback) {
					this.currentUID += 1;
					var listener = {
						group: group,
						UID: this.currentUID,
						sendMessage: (function (that) {
							return function (message, channel) {
								return that.sendMessage(this.group, message, channel);
							};
						}(this)),
						destroy: (function (that) {
							return function () {
								return that.removeListener(this);
							};
						}(this))
					};

					this.messagePool[group] = this.messagePool[group] || {};
					this.messagePool[group][listener.UID] = callback;
					return listener;
				},
				/**
				 * Remove a registered callback
				 * @param {Object} listener Listener resource object
				 */
				removeListener: function (listener) {
					try {
						delete this.messagePool[listener.group][listener.UID];
					}
					catch (ignore) {}
				},
				/**
				 * Send a message to a listener group.
				 * @param {String} group Listener group reference by name
				 * @param {Object} message Message to be send to the specified listener group
				 * @param {String} channel Message channel to allow listener callback to filter messages
				 * targeted at specific listeners.
				 */
				sendMessage: function (group, message, channel) {
					var messageGroup = this.messagePool[group],
					exceptions = [],
					callback;
					for (callback in messageGroup) {
						if (messageGroup.hasOwnProperty(callback)) {
							try {
								messageGroup[callback](message, channel);
							}
							catch (e) {
								exceptions.push({
									message: 'Callback failed for' + callback,
									exception: e
								});
							}
						}
					}
					return exceptions;
				}
			};

			window[namespace][className] = new MessageController();

		}('MessageController', 'Foundation'));

		// 
		// create a VirtualEntity by accepting a model.
		// if the model can be converted to a virtual entity
		// extract the child models from the virtual entity
		// otherwise throw an error stating that the model can not be converted to a virtual entity
	
		var VirtualEntity = function (model) {
			var modelCanBeConverted = this["verify that the model can be converted to a virtual entity"](model);
			if (modelCanBeConverted) {
				this.childModels = this["extract child models"](model);
				this["generate asynchronous getters and settors for the model"](model);
			}
			else {
				throw new Error("Model can not be converted to a virtual entity");
			}
		};
		
		VirtualEntity.prototype = {
			"generate asynchronous getters and settors for the model": function (model) {
				for (var property in model) {
					if (model.hasOwnProperty(property)) {
						if (typeof model[property] !== "Object") {
							Object.defineProperty(this, property, {
								get: function () { return this[property]; },
								set: function (value) { this[property] = value; }
							});
						}
					}
				}
			},
			"verify that the model can be converted to a virtual entity": function (model) {
				if (model && this["check that the model is an object"](model)) {
					console.log("Virtual entity is an object.");					
					return true;
				}
				else {
					console.log("Model isn't an object.");
					return false;
				}
			},
			"check that the model is an object": function (model) {
				console.log(typeof model);
				return typeof model === "object";
			},
			"extract child models": function (model) {
				var childModels = [];
				for (var property in model) {
					if (model.hasOwnProperty(property)) {
						if (typeof model[property] === "Object") {
							childModels[property] = new VirtualEntity(model[property]);
						}
					}
				}
				
				return childModels;
			}
		};
	
	
	
	
	
	
	
	
		var socket = io.connect('http://166.78.180.166:9374');
		


		// 
		// 
		// $handle("account-controller").with(function (msg) {
		// 	console.log(msg);
		// });
		// 	
		// $with("account-controller").and("logger").resolve("as a user i would like to login").for({username:"scott", password:"test"});
		// 
		// $handle("logger").with(function (msg) {
		// 	console.log(msg);
		// });	
		// 	
		// $to("logger").say({logger:"is online"});
		// 	
		// $handle("pong").with(function () {
		// 	$to("logger").say(arguments);
		// });
		// 	
		// $handle("localization").with(function (message) {
		// 	$to("logger").say("Translating: " + message.translate);
		// });
		// 	
		// $to("localization").say({translate:"Hello world", language:"german"});
		// 	
		// // $to("action").say("a user would like to login", data:{})
		// // $to("action").say({message:{data:{}}})
		// 	
		// $with("logger").and("logger").resolve("user would like to login").for({username:"scott", password:"test"});
		// 	
		</script>		
		<script type="text/javascript">
		
		
	
		
		
		
		
		
		</script>
		

		<style>
		@font-face {
		  font-family: 'Open Sans';
		  font-style: normal;
		  font-weight: 400;
		  src: local('Open Sans'), local('OpenSans'), url('http://themes.googleusercontent.com/static/fonts/opensans/v5/cJZKeOuBrn4kERxqtaUH3T8E0i7KZn-EPnyo3HZu7kw.woff') format('woff');
		}
		
		
		*[data-widget="json-form"] div {
			border-bottom:1px solid #FAFAFA;
		}
		
		fieldset legend {
			font-weight:bold;
			text-transform:uppercase;
/*			border-bottom:1px solid #EAEAEA;*/
			padding-top:10px;
			padding-bottom:10px;
			display:block;
		}
		
		fieldset label {
			text-align:right;
			width:100px;
			border-right:1px solid #FAFAFA;
			padding:5px;
			display:inline-block;
		}
		
		fieldset input {
			width:200px;
		}

		th {
			border-bottom:2px solid #E0E0E0;
/*			border-right:2px solid #E0E0E0;	*/
			padding:5px 10px;
			margin:3px;
			text-transform:uppercase;
			font-family: 'open sans',arial,sans-serif;
			text-align:left;
			
			
			box-shadow:0px 0px 46px -16px #ccc;
		}
		
		td {
			vertical-align:top;
			border:1px solid #FFF;
			background:#FAFAFA;
/*			border-bottom:1px solid #EAEAEA;
			border-right:1px solid #E0E0E0;*/
			padding:15px;
			margin:3px;
/*			box-shadow: 0 0 -4px 5px #000;*/
			box-shadow:0px 0px 46px -16px #ccc;

		}
		
		tr:hover {
			background-color:#FAFAFA;
		}
		
		td:hover {
			background-color:#FFF !important;
			border:1px solid #FAFAFA;
			box-shadow:0px 0px 66px -26px #000;
			cursor:pointer;
		}
		
		div#json-form {
			
		}
		
		body {
			margin:0;
			padding:0;
		}
		
		section[data-widget="entity-builder"] {
			border:1px solid #E0E0E0;
		}

		section[data-widget="entity-builder"] h1 {
			
		}	
		
		li[data-widget="list-element"] {
			list-style: none;
			border-bottom:1px solid #CCC;
		}	
		
		section[data-widget="account-controller"] {
			border-bottom:1px solid #CCC;
			background:#FAFAFA;
			box-shadow: 0px 2px 4px #CCC;
			margin:0px;
			padding:5px;
			height:30px;
			overflow:hidden;
		}
		
		
		/*general style*/
		html, body {
		    margin: 0 auto;
		    padding: 0;
			max-width:800px;
			font-family:sans-serif;
			font-weight:200;
			background:#333;
			-webkit-touch-callout: none;
			-webkit-user-select: none;
			-khtml-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;

		}


		header, hgroup, nav, section, article, aside, footer {
		    display: block;
		}

		a {
		    text-decoration: none;
		    color: #000;
		}

		a:hover {
		    text-decoration: underline;
		    	-webkit-transition: 0.7s ease;
		    	-moz-transition: 0.7s ease;
		    	-ms-transition: 0.7s ease;
		    	-o-transition: 0.7s ease;
		}

		hr {
		    width: 380px;
		}

		#wrapper {
		    width: 100%;
		    margin: 0 auto;
		}
		/*header area*/
		header {
			position:absolute;
			left:0;
			right:0;
			top:0;
			height:75px;
		    background: #333;
		/*	-webkit-box-shadow: inset 0px -10px 20px rgba(0,0,0,0.3);
			-moz-box-shadow: inset 0px -10px 20px rgba(0,0,0,0.3);
			box-shadow: inset 0px -10px 20px rgba(0,0,0,0.3);*/
		}

		hgroup h1 {
		    color: #999;
			margin-left:-20px;
			font-weight:200;
			float:left;
			margin-top:14px;
			width:100%;
			text-align:right;
		}
		/*nav area*/
		nav {
		/*    width: 100%;*/
		/*    height: 20px;*/
		/*    background: #C66;*/
		/*    margin-left: 200px;*/
		/*	float:right;*/

		}

		nav ul {
		/*    margin: 0 0 0 -10px;*/
		}

		nav li {
		/*    float: left;*/
		    list-style-type: none;
		/*    padding: 0 10px;*/
		}
		/*section area*/
		section {
		/*    width: 400px;*/
		/*    background: #CCC;*/
		    margin-top: -20px;
		}

		hgroup h2 {
		    color: #000;
		    padding: 10px 0 0 10px;
		}

		article {
		/*    width: 400px;*/
		/*    background: #CCC;*/
		}

		article p {
		    padding: 10px;
		}
		/*aside area*/
		aside {
		    background: #FAFAFA;
		/*	border-right: 1px solid #CCC;*/
		/*	box-shadow: 0px 1px 2px #FFF;*/
			position:absolute;
			left:0;
			top:0;
			bottom:0;
			width:250px;
		}

		hgroup h3 {
		    color: #fff;
		    padding: 10px 0 0 10px;
		}

		aside article {
		    color: #FFF;
		}

		input {
		    background-color: #fff;
		    border: 1px solid #ccc;
		    -webkit-box-shadow: inset 0 1px 1px rgba(0,0,0,0.075);
		    -moz-box-shadow: inset 0 1px 1px rgba(0,0,0,0.075);
		    box-shadow: inset 0 1px 1px rgba(0,0,0,0.075);
		    -webkit-transition: border linear 0.7s,box-shadow linear 0.7s;
		    -moz-transition: border linear 0.7s,box-shadow linear 0.7s;
		    -o-transition: border linear 0.7s,box-shadow linear 0.7s;
		    transition: border linear 0.7s,box-shadow linear 0.7s;

		    display: inline-block;
		    height: 18px;
		    padding: 4px 6px;
		    margin-bottom: 9px;
		    font-size: 12px;
		    line-height: 18px;
		    color: #666;
		    -webkit-border-radius: 4px;
		    -moz-border-radius: 4px;
		    border-radius: 4px;
		    vertical-align: middle;
		}

		div.row {
		    width:100%;
		    height:100px;
		}
		.span4 {
		    width: 370px;
		    float: left;
		    min-height: 1px;
		    margin-left: 30px;
		}

		.help-inline {
		display: inline-block;
		vertical-align: middle;
		padding-left: 5px;
		}

		fieldset {
		padding: 0;
		margin: 0;
		border: 0;
		}

		legend {
		font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
		font-size: 15.6px;
		margin-bottom: 0;
		}

		div#tool-drawer-handler {
			z-index:101;
			position:absolute;
			top:0;
			bottom:0;
			top:48%;

		/*	margin-top:90%;*/
			width:20px;
			text-align:right;
			line-height:4px;
			vertical-align:middle;
			right:-5px;
		/*	background:#FEFEFE;*/
			cursor:move;
			opacity:0.6;
			-webkit-touch-callout: none;
			-webkit-user-select: none;
			-khtml-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;
		}


		/*footer area*/
		footer {
			position:absolute;

			bottom:0px;
			left:0px;
			right:0px;
		    height: 75px;
		    background: #333;
			z-index:0;
		/*    border-top: 1px solid #000;*/
			text-align:right;
			color:#666 !important;
			padding-right:20px;

			    	-webkit-transition: 0.7s ease;
		        	-moz-transition: 0.7s ease;
		        	-ms-transition: 0.7s ease;
		        	-o-transition: 0.7s ease;
		/*	
			-webkit-box-shadow: inset 0px 10px 20px rgba(0,0,0,0.3);
			-moz-box-shadow: inset 0px 10px 20px rgba(0,0,0,0.3);
			box-shadow: inset 0px 10px 20px rgba(0,0,0,0.3);*/




		}

		footer.overlay {
		    top:65px !important;
		    height:100% !important;
		    z-index:111 !important;
		    background:#EEE !important;
		}

		footer p {
		    padding: 10px 0 0 10px;
		}

		#Foundation {
			position:absolute;
			left:0;
			right:0;
			top:75px;
			bottom:55px;
		}

		#Activities {
		    overflow:hidden;
			border-radius:5px;
			z-index:100;
			position: absolute;
			left: 250px;
			right: 20px;
			top: 20px;
			bottom: 0px;
			background: #FFF;
	
			-webkit-box-shadow:  0 0px 126px rgba(0,0,0,1.55);
			-moz-box-shadow:  0 0px 126px rgba(0,0,0,1.55);
			box-shadow:  0 0px 126px rgba(0,0,0,1.55)
	
		}

		#Activities section.activity-view {
		    padding: 30px;
		    margin-top: 10px;
		    overflow: scroll;
		    position: absolute;
		    top: 62px;
		    left: 0;
		    right: 0px;
		    bottom: 0px;
		}

		#Activities nav {
			border-top-left-radius:5px;
			border-top-right-radius:5px;
			position:relative;
		/*	margin:5px;*/
			height:60px;
			clear:both;
		/*	min-height: 20px;*/
		/*	padding: 19px;*/
		/*	margin-bottom: 20px;*/
			background-color: #f5f5f5;
			border: 1px solid #e3e3e3;
			-webkit-box-shadow: inset 0 -2px 26px rgba(0,0,0,0.15);
			-moz-box-shadow: inset 0 -2px 26px rgba(0,0,0,0.15);
			box-shadow: inset 0 -2px 26px rgba(0,0,0,0.15)
			text-align:center;
	
			border-bottom:1px solid #CCC;

		}

		#Activities nav h2 {
			display:inline;
			line-height:62px;
			padding-left:20px;
			font-weight:200;
		}

		#Activities nav span {
			display:inline-block;
			position:absolute;
			top:8px;
			right:8px;
		}




		/*

			TOOL BAR

		*/
		#Tools nav {
			background:#333;
		/*	border-top:1px solid #DDD;*/
			height:100%;
			color:#FFF;

	
		/*	-webkit-box-shadow: inset 0 -2px 50px rgba(0,0,0,0.3);
			-moz-box-shadow: inset 0 -2px 50px rgba(0,0,0,0.3);
			box-shadow: inset 0 -2px 50px rgba(0,0,0,0.3);*/

		}

		#Tools nav ul {
			padding:0px;
			margin:0px;
		}

		#Tools nav h3 {
		/*	border-bottom:1px solid #444;*/
			padding:20px;
			margin:0px;
			font-weight:500;
		    color: #444;
		    text-shadow: 0px 0px 15px #222;
		}

		#Tools nav ul li {
			width:100%;
		/*	border-bottom:1px solid #383838;*/
		/*	border-top:1px solid #383838;*/
			padding:20px 0;
			text-indent:20px;
			-webkit-box-shadow: inset 0 0px 36px rgba(0,0,0,0.1);
			-moz-box-shadow: inset 0 0px 36px rgba(0,0,0,0.1);
			box-shadow: inset 0 0px 36px rgba(0,0,0,0.1);
			margin-bottom:8px;
			text-overflow: ellipsis;
		    min-width: 200px;


			border-width: 0px;
			border-color: rgba(0,0,0,0);


			-webkit-box-sizing: border-box;
			-moz-box-sizing: border-box;
			box-sizing: border-box;

			-webkit-transition: 0.7s ease;
			-moz-transition: 0.7s ease;
			-ms-transition: 0.7s ease;
			-o-transition: 0.7s ease;
		border-style: dashed;

		/*	border-right:1px solid #FFF;*/
	
		}

		@keyframes fadeInNavButton {
		  from {
		    background: black;
		  }

		  to {
		    background: white;
		  }
		}



		#Tools nav ul li:hover {
			border-width: 0;
			border-color: rgba(0, 0, 0, 0.5);
			background: #FFF;
		  animation-duration: 0.7s;
		  animation-name: fadeInNavButton;
			color:#333;
			cursor:pointer;
			-webkit-box-shadow: inset 0 2px 26px rgba(0,0,0,0.2);
			-moz-box-shadow: inset 0 2px 26px rgba(0,0,0,0.2);
			box-shadow: inset 0 2px 26px rgba(0,0,0,0.2);
		}


		#Tools nav ul li.active {
	
			color:#333;

			background:#CCC;

	
			-webkit-box-shadow: inset 0 2px 26px rgba(0,0,0,0.1);
			-moz-box-shadow: inset 0 2px 26px rgba(0,0,0,0.1);
			box-shadow: inset 0 2px 26px rgba(0,0,0,0.1);

		    	-webkit-transition: 0.7s ease;
		    	-moz-transition: 0.7s ease;
		    	-ms-transition: 0.7s ease;
		    	-o-transition: 0.7s ease;
		}

		#Tools nav ul li.active:hover {
			background:#FFF;
			cursor:pointer;
	
	
			-webkit-box-shadow: inset 0 2px 6px rgba(0,0,0,0.1);
			-moz-box-shadow: inset 0 2px 6px rgba(0,0,0,0.1);
			box-shadow: inset 0 2px 6px rgba(0,0,0,0.1);
	
			-webkit-box-shadow: inset 0 2px 26px rgba(0,0,0,0.1);
			-moz-box-shadow: inset 0 2px 26px rgba(0,0,0,0.1);
			box-shadow: inset 0 2px 26px rgba(0,0,0,0.1);
		}









		button{
			cursor: pointer;
			text-decoration:none;
			border: 1px solid rgb(0, 153, 204);
			padding: 10px 15px 10px 15px;
			color:rgb(255, 255, 255);
			font-size:15px;
			font-family:arial, serif;
			text-shadow: 0px 0px 3px rgb(0, 0, 0);
			font-size: 15px;
			border-radius:7px;
		/*	-moz-border-radius:20px 20px 20px 20px;*/
		/*	-webkit-border-radius:20px 20px 20px 20px;*/
			box-shadow:0px 0px 63px rgba(255, 255, 255, 0.6);
		/*	-moz-box-shadow:0px 0px 3px rgba(0, 0, 0, 0.3);*/
		/*	-webkit-box-shadow:0px 0px 3px rgba(0, 0, 0, 0.3);*/
		/*	background-color: rgb(0, 153, 255);
			background-image:linear-gradient(-90deg, rgb(0, 204, 255), rgb(0, 153, 255));
			background-image:-webkit-gradient(linear, 50% 0%, 50% 100%, from(rgb(0, 204, 255)), to(rgb(0, 153, 255)));
			background-image:-moz-linear-gradient(-90deg, rgb(0, 204, 255), rgb(0, 153, 255));*/
			background:#09F;
			    	-webkit-transition: 0.7s ease;
		        	-moz-transition: 0.7s ease;
		        	-ms-transition: 0.7s ease;
		        	-o-transition: 0.7s ease;
		}
		button:hover{
			cursor: pointer;
			text-decoration:none;
			border: 1px solid rgb(0, 153, 204);
			padding: 10px 15px 10px 15px;
			color:rgb(255, 255, 255);
			font-size:15px;
			font-family:arial, serif;
			text-shadow: 0px 0px 4px rgb(0, 0, 0);
			font-size: 15px;
			border-radius:10px;
		/*	-moz-border-radius:20px 20px 20px 20px;
			-webkit-border-radius:20px 20px 20px 20px;
		*/	box-shadow:0px 0px 3px rgba(0, 0, 0, 0.3);
			-moz-box-shadow:0px 0px 3px rgba(0, 0, 0, 0.3);
			-webkit-box-shadow:0px 0px 3px rgba(0, 0, 0, 0.3);
			background-color: rgb(0, 153, 255);
			background-image:linear-gradient(-90deg, rgba(0, 204, 255, 0.8), rgba(0, 153, 255, 0.9));
			background-image:-webkit-gradient(linear, 50% 0%, 50% 100%, from(rgba(0, 204, 255, 0.8)), to(rgba(0, 153, 255, 0.9)));
			background-image:-moz-linear-gradient(-90deg, rgba(0, 204, 255, 0.8), rgba(0, 153, 255, 0.9));
		}
		button:active{
			cursor: pointer;
			text-decoration:none;
			border: 1px solid rgb(0, 153, 204);
			padding: 10px 15px 10px 15px;
			color:rgb(255, 255, 255);
			font-size:15px;
			font-family:arial, serif;
			text-shadow: 0px 0px 3px rgb(0, 0, 0);
			font-size: 15px;
			border-radius:20px 20px 20px 20px;
			-moz-border-radius:20px 20px 20px 20px;
			-webkit-border-radius:20px 20px 20px 20px;
			box-shadow:0px 0px 3px rgba(0, 0, 0, 0.3);
			-moz-box-shadow:0px 0px 3px rgba(0, 0, 0, 0.3);
			-webkit-box-shadow:0px 0px 3px rgba(0, 0, 0, 0.3);
			background-color: rgb(0, 153, 255);
			background-image:linear-gradient(-90deg, rgb(0, 153, 255), rgb(0, 153, 255));
			background-image:-webkit-gradient(linear, 50% 0%, 50% 100%, from(rgb(0, 153, 255)), to(rgb(0, 153, 255)));
			background-image:-moz-linear-gradient(-90deg, rgb(0, 153, 255), rgb(0, 153, 255));
		}


		.well {
			clear:both;
			min-height: 20px;
			padding: 19px;
			margin-bottom: 20px;
			background-color: #f5f5f5;
			border: 1px solid #e3e3e3;
			-webkit-border-radius: 4px;
			-moz-border-radius: 4px;
			border-radius: 4px;
			-webkit-box-shadow: inset 0 1px 1px rgba(0,0,0,0.05);
			-moz-box-shadow: inset 0 1px 1px rgba(0,0,0,0.05);
			box-shadow: inset 0 1px 1px rgba(0,0,0,0.05);
			text-align:center;
		}

		section.api-service-header h4 {
		    border-bottom:1px solid #DDD;
		    margin:0px;
		    font-weight: 100;
		    font-size: 30px;
		    text-transform: uppercase;
		    letter-spacing: 3px;
		    text-align:left;
		}

		section.api-service-method span {
		    font-size: 0.5em;
		    letter-spacing: 1px;
		    color: #AAA;
		    padding-left: 2px;
		}









		table.hovertable {
			font-family: verdana,arial,sans-serif;
			font-size:11px;
			color:#333333;
			border-width: 1px;
			border-color: #999999;
			border-collapse: collapse;
			width:100%;
		}
		table.hovertable th {
			background-color:#FAFAFA;
			border-width: 1px;
			padding: 8px;
			border-style: solid;
			border-color: #DDD;
			text-align:left;
		}
		table.hovertable tr {
			background-color:#FCFCFC;
		}
		table.hovertable td {
			border-width: 1px;
			padding: 16px 8px;
			border-style: solid;
			border-color: #EEE;
			border-right:1px solid #DDD;
			font-weight: 100;
		    font-size: 17px;
		}

		table.hovertable td:hover {
		    background:#EFFFEE;
		}








		article.account-login-form {

		    position:absolute;
		    top:-100px;
		    left:50%;
		    margin-top:-150px;
		    height:0px;
		    width:250px;
		    overflow:hidden;
		    padding:100px;

		    border:1px solid #DDD;
		    margin-left:-200px;
		    border-radius:5px;
		    background-color:#FFF;

		    -webkit-transition: 0.7s ease;
		    -moz-transition: 0.7s ease;
		    -ms-transition: 0.7s ease;
		    -o-transition: 0.7s ease;


		    box-shadow: 0 0px 1px rgba(0,0,0,0.2);
		}

		article.account-login-form.overlay {
		    z-index:200;
		    height:100px;
		    top:50%;

		    box-shadow: 0 0px 516px rgba(0,0,0,0.7);
		}


		article.account-login-form legend {
		    margin: 0;
		    padding-bottom: 15px;
		    text-indent: 0px;
		    font-size: 20px;
		}

		article.account-login-form input {
		    float:right;
		}

		article.account-login-form div {
		    clear:both;
		}


























		.cf:before, .cf:after{
		    content:"";
		    display:table;
		}

		.cf:after{
		    clear:both;
		}

		.cf{
		    zoom:1;
		}







		/* Form wrapper styling */
		.form-wrapper {
		    width: 650px;
		    padding: 15px 15px 10px 15px;
		    margin: 10px auto 50px auto;
		    background: #CCC;

		    border-radius: 10px;
		    box-shadow: 0 1px 1px rgba(0,0,0,.4) inset, 0 1px 0 rgba(255,255,255,.2);
		}

		/* Form text input */

		.form-wrapper input {
		    width: 530px;
		    height: 20px;
		    padding: 10px 5px;
		    float: left;
		    font: bold 15px 'lucida sans', 'trebuchet MS', 'Tahoma';
		    border: 0;
		    background: #eee;
		    border-radius: 3px 0 0 3px;
		}

		.form-wrapper input:focus {
		    outline: 0;
		    background: #fff;
		    box-shadow: 0 0 2px rgba(0,0,0,.8) inset;
		}

		.form-wrapper input::-webkit-input-placeholder {
		   color: #999;
		   font-weight: normal;
		   font-style: italic;
		}

		.form-wrapper input:-moz-placeholder {
		    color: #999;
		    font-weight: normal;
		    font-style: italic;
		}

		.form-wrapper input:-ms-input-placeholder {
		    color: #999;
		    font-weight: normal;
		    font-style: italic;
		}

		/* Form submit button */
		.form-wrapper button {
		    overflow: visible;
		    position: relative;
		    float: right;
		    border: 0;
		    padding: 0;
		    cursor: pointer;
		    height: 40px;
		    width: 110px;
		    font: bold 15px/40px 'lucida sans', 'trebuchet MS', 'Tahoma';
		    color: #fff;
		    text-transform: uppercase;
		    background: #09F;
		    border-radius: 0 3px 3px 0;
		    text-shadow: 0 -1px 0 rgba(0, 0 ,0, .3);
		}

		.form-wrapper button:hover{
		    background: #09F;
		}

		.form-wrapper button:active,
		.form-wrapper button:focus{
		    background: #09F;
		    outline: 0;
		}

		.form-wrapper button:before { /* left arrow */
		    content: '';
		    position: absolute;
		    border-width: 8px 8px 8px 0;
		    border-style: solid solid solid none;
		    border-color: transparent #09F transparent;
		    top: 12px;
		    left: -6px;
		}

		.form-wrapper button:hover:before{
		    border-right-color: #09F;
		}

		.form-wrapper button:focus:before,
		.form-wrapper button:active:before{
		        border-right-color: #09F;
		}

		.form-wrapper button::-moz-focus-inner { /* remove extra button spacing for Mozilla Firefox */
		    border: 0;
		    padding: 0;
		}

		div#dialog {
			z-index: 1000000;
			position: fixed;
			background: #FFF;
			width: 50%;
			margin-top: 25%;
			margin-left: 25%;
			box-shadow: 0 0 50px 24px #000;
			border: 1px solid #CCC;
			border-radius: 10px;
		}







		#Activities nav span.star-rating {
		    position: relative;
		    margin-left: 20px;
		    top: 18px;
		    font-size: 43px;
		    color: orange;
		}
		</style>
		
	</head>
	
<!-- 	<aspects>
	
		
	
	</aspects>
	 -->
	<body id="wrapper">

		<section data-controller="plant-controller" data-entity="plant-entity" data-instance-id="12312312312"></section>

		<header>
			
		    <hgroup>
		        <h1 data-widget="server-health-controller" data-group="server-health">
		            CopyByte
		        </h1>
		    </hgroup>


<!-- 		    <datalist data-widget="application-controller" data-group="activity">

		        <figure data-widget="entity-library" data-group="activity">
		        </figure>
		        <figure data-widget="personas" data-group="activity">
		        </figure>
		        <figure data-widget="activities" data-group="activity">
		        </figure>
		        <figure data-widget="tasks" data-group="activity">
		        </figure>

		        <figure data-widget="logger" data-group="navigation">
		        </figure>

		        <figure data-widget="logger" data-group="user-account">
		        </figure>

		        <figure data-widget="user-account-controller" data-group="user-account"></figure>

		    </datalist> -->
		</header>

		<div id="dialog" data-widget="master-dialog" data-group="master-dialog">
			
			<h3>Header</h3>
			<p>
				Information Sections
			</p>
			<div class="well">
				<button data-widget="user-action" data-event="click" data-group="nodary-controller" data-channel="show list for user" class="call-to-action" id="login-button">   
					Yes
				</button>	

				<button data-widget="user-action" data-event="click" data-group="nodary-controller" data-channel="show list for user" class="call-to-action" id="login-button">   
					No
				</button>	
			</div>
			
		</div>
		
		<article id="Foundation">
		    <section id="Activities" data-widget="activity-controller" data-group="activities" data-session-required="true">
		        <nav>
		            <h2 data-widget="activity-title" data-group="activities">
		            </h2>
		            <span class="star-rating" data-widget="star-rating" data-min="0" data-max="5" data-value="0.3"></span>
		            <span data-widget="call-to-action-controls" data-group="call-to-action">
		            </span>

		        </nav>
		        <section id="my-account" class="activity-view">
		            <datalist data-widget="call-to-action-configuration" data-group="call-to-action" data-for="my-account">

		                <!--<figure data-label="Add Entity" data-action="add a new entity to the entity library" data-type="call-to-action" data-outbound-group="entity-library-controller">-->
		                <!--</figure>-->

		            </datalist>

		            <fieldset class="inputs">
		                <div class="row">
		                    <div class="span4">
		                        <div class="string control-group required stringish" id="user_first_name_input"><label
		                                class=" control-label" for="user_first_name">First name*</label>

		                            <div class="controls"><input id="user_first_name" maxlength="255"
		                                                         name="user[first_name]" type="text" value="">

		                            </div>
		                        </div>
		                    </div>
		                    <div class="span4">
		                        <div class="string control-group required stringish" id="user_last_name_input"><label
		                                class=" control-label" for="user_last_name">Last name*</label>

		                            <div class="controls"><input id="user_last_name" maxlength="255" name="user[last_name]"
		                                                         type="text" value="">

		                            </div>
		                        </div>
		                    </div>
		                </div>
		                <div class="row">
		                    <div class="span4">
		                        <div class="string control-group required stringish" id="user_username_input"><label
		                                class=" control-label" for="user_username">Username*</label>

		                            <div class="controls"><input id="user_username" maxlength="255" name="user[username]"
		                                                         type="text" value="">

		                                <span class="help-inline">You can log in to Notary using your username or your email address.</span>
		                            </div>
		                        </div>
		                    </div>
		                    <div class="span4">
		                        <div class="email control-group required stringish" id="user_email_input"><label
		                                class=" control-label" for="user_email">Email*</label>

		                            <div class="controls"><input id="user_email" maxlength="255" name="user[email]"
		                                                         type="email" value="">

		                            </div>
		                        </div>
		                    </div>
		                </div>

		            </fieldset>
		            <div class="well well-small" style="text-align:left; margin-top:30px;">
		                <fieldset class="form-actions">
		                    <button class="call-to-action">Save My Account</button>
		                    <a href="" class="btn btn-link" style="margin-left:10px">Cancel</a>
		                </fieldset>
		            </div>
					
					<div data-widget="json-form" id="json-form" data-entity="forcast">
						<code>
							{
							        "title": "Good Idea #4: Make A Wish",
							        "url": "http:\/\/www.vimeo.com\/753571",
							        "id": "753571",
							        "description": "Tyler, Scott, and Jared meet a mysterious...\n",
							        "upload_date": "2008-03-04 15:57:58",
							        "thumbnail_small": "http:\/\/20.media.vimeo.com\/...jpg",
							        "thumbnail_medium": "http:\/\/60.media.vimeo.com\/...jpg",
							        "thumbnail_large": "http:\/\/30.media.vimeo.com\/...jpg",
							        "user_name": "Kinetiq HD",
							        "user_url": "http:\/\/www.vimeo.com\/user346742",
							        "user_portrait_small": "http:\/\/40.media.vimeo.com\/...jpg",
							        "user_portrait_medium": "http:\/\/00.media.vimeo.com\/...jpg",
							        "user_portrait_large": "http:\/\/10.media.vimeo.com\/...jpg",
							        "stats_number_of_likes": "38",
							        "stats_number_of_plays": "19312",
							        "stats_number_of_comments": 25,
							        "tags": ""
							    }
						</code>
					</div>

		        </section>

		        <section id="my-records" data-widget="my-records-controller" data-group="my-records-controller"
		                 class="activity-view">
		            <datalist data-widget="call-to-action-configuration" data-group="call-to-action" data-for="my-records">

		                <figure data-label="Search Records" data-action="search for a record" data-type="call-to-action"
		                        data-outbound-group="my-records-controller">
		                </figure>
		                <figure data-label="Add Record" data-action="add a record" data-type="call-to-action"
		                        data-outbound-group="my-records-controller">
		                </figure>

		                <figure data-label="Edit Record" data-action="edit a record" data-type="call-to-action"
		                        data-outbound-group="my-records-controller">
		                </figure>


		            </datalist>
		            <section class="form-wrapper cf">
						<input id="username-input" data-widget="label-input" data-omit-label="true" data-type="string" data-group="records" data-channel="search" placeholder="Enter Labels..." required />
		                <!-- <input type="text" placeholder="Enter Labels..." required> -->
						<button data-widget="user-action" data-event="click" data-group="nodary-controller" data-channel="show list for user" class="call-to-action" id="login-button">   
							Clear
						</button>	
		                <!-- <button type="submit">Search</button> -->
		            </section>
		            <!-- <div class="well"> -->
		                <!-- <button data-widget="user-action" data-event="click" data-group="nodary-controller" data-channel="show writtings list for user" class="call-to-action" id="login-button">Writtings</button> -->
		                <!-- <button data-widget="user-action" data-event="click" data-group="nodary-controller" data-channel="show music list for user" class="call-to-action" id="login-button">Music</button> -->
		                <!-- <button data-widget="user-action" data-event="click" data-group="nodary-controller" data-channel="show photo list for user" class="call-to-action" id="login-button">Photos</button> -->
		                <!-- <button data-widget="user-action" data-event="click" data-group="nodary-controller" data-channel="show video list for user" class="call-to-action" id="login-button">Video</button> -->

						<!-- <button data-widget="user-action" data-event="click" data-group="nodary-controller" data-channel="show list for user" class="call-to-action" id="login-button">   
							Get List For User
						</button>	 -->
		            <!-- </div> -->
					
					
					
					<!-- <section data-widget="records-list" data-group="records">
						
					</section> -->

					<section data-widget="record-list" data-group="nodary-controller">

					</section>
					<form data-widget="event" data-group="nodary-controller" data-channel="show list for user" data-message=":" >   
					</form>
		        </section>

				<section id="settings" data-widget="settings-controller" data-group="settings-controller" class="activity-view">
					<div class="well">
		                <button data-widget="user-action" data-event="click" data-group="collaborate" data-channel="user did would like to add an entity to the diagram" class="call-to-action" id="login-button">Add Entity</button>
						<!-- <button data-widget="user-action" data-event="click" data-group="collaborate" data-channel="broadcast state" class="call-to-action" id="login-button">Edit Clients</button>
						<button data-widget="user-action" data-event="click" data-group="collaborate" data-channel="broadcast state" class="call-to-action" id="login-button">Sync Clients</button> -->
					</div>
					<div data-widget="collaborate" data-group="collaborate"></div>
	                <button data-widget="user-action" data-event="click" data-group="collaborate" data-channel="broadcast state" class="call-to-action" id="login-button">Sync Clients</button>
	                <button data-widget="user-action" data-event="click" data-group="settings-controller" data-message="get settings" data-channel="get settings" class="call-to-action" id="login-button">Get Settings</button>
						
					<section data-widget="settings-manager" data-group="settings-controller">

					</section>
					<h2>Privacy Settings</h2>

					<section data-widget="nodary-controller" data-group="nodary-controller">
						<input id="username-input" data-widget="user-input" data-omit-label="false" data-event="blur" data-type="string" data-group="nodary-controller" data-channel="create new nodary" placeholder="Enter Labels..." required />		
					</section>
					<h2>Account Settings</h2>
					<button data-widget="user-action" data-event="click" data-group="jenkins" data-channel="What is the high today?">   
						Check Local Weather
					</button>
				</section>

		        <section id="api-documentation" class="activity-view" data-widget="api-documentation-controller"
		                 data-group="api-documentation-controller" data-endpointpath="health/endpoints">

		            <datalist data-widget="call-to-action-configuration" data-group="call-to-action"
		                      data-for="api-documentation">

		                <figure data-label="Call Method" data-action="call the active method in the api documentation"
		                        data-type="call-to-action" data-outbound-group="api-documentation-controller">
		                </figure>

		            </datalist>

		        </section>

		        <section id="api-console" class="activity-view">
		            <datalist data-widget="call-to-action-configuration" data-group="call-to-action" data-for="api-console">

		                <figure data-label="Clear Console" data-action="clear the api console" data-type="call-to-action"
		                        data-outbound-group="api-console-controller">
		                </figure>

		            </datalist>

		        </section>
		    </section>
		    <aside id="Tools">
		        <div id="tool-drawer-handler" data-widget="drawer-handle" data-group="activities">
		            .
		            <br/>
		            .
		            <br/>
		            .
		        </div>

		        <nav data-widget="navigation-controller" data-group="activities">
							<section data-widget="voice-input" data-group="activities"></section>
		            <h3>
		                Tools
		            </h3>
		            <ul>
		                <li data-widget="user-action" data-event="click" data-message="go-to-my-records"
		                    data-group="activities">
		                    My Records
		                </li>
		                <li data-widget="user-action" data-event="click" data-message="go-to-my-account"
		                    data-group="activities">
		                    My Account
		                </li>
		                <li data-widget="user-action" data-event="click" data-message="go-to-settings"
		                    data-group="activities">
		                    Settings
		                </li>
		                <!-- <li class="active" data-widget="user-action" data-event="click"
		                    data-message="go-to-api-documentation" data-group="activities">
		                    API Documentation
		                </li>
		                <li data-widget="user-action" data-event="click" data-message="go-to-api-console"
		                    data-group="activities">
		                    API Console
		                </li> -->
						
		            </ul>
		        </nav>
		    </aside>

		</article>

		<article data-widget="account-overlay" data-group="account-controller" class="account-login-form overlay">
					<!-- <section data-widget="voice-input" data-group="account-controller"></section> -->
		    <!-- <datalist>
		        <figure data-widget="conduit" data-group="dialog" data-outlet="user-account">
		        </figure>

		        <figure data-widget="conduit" data-group="user-account" data-outlet="dialog">
		        </figure>
		    </datalist> -->
		    <section>
		        <fieldset data-widget="account-controller" data-group="account-controller">
		            <legend>Account Login</legend>
		

						<div>
							<input id="username-input" data-widget="user-input" data-type="string" data-group="account-controller" data-channel="username" />
						</div>
						<div>
							<input id="password-input" data-widget="user-input" data-type="password" data-group="account-controller" data-channel="password" />
						</div>
						


						<div>
							<button data-widget="user-action" data-event="click" data-group="account-controller" data-channel="user did ask to log in" class="call-to-action" id="login-button">   
								Login
							</button>
							<button data-widget="user-action" data-event="click" data-group="account-controller" data-channel="register new user" class="call-to-action" id="register-button">   
								Register
							</button>
						</div>
					
		        </fieldset>
		    </section>
		</article>


		<!--<section>-->
		    <!--<fieldset>-->
		        <!--<legend>Account Controller</legend>-->
		        <!--<model>-->
		            <!--<entity>-->
		                <!--<name>Account</name>-->
		                <!--<properties>-->
		                    <!--<property>-->
		                        <!--<name>Username</name>-->
		                        <!--<type>String</type>-->
		                        <!--<range>-->
		                            <!--<min>1</min>-->
		                            <!--<max>100</max>-->
		                        <!--</range>-->
		                    <!--</property>-->
		                    <!--<property>Password</property>-->
		                <!--</properties>-->
		            <!--</entity>-->

		        <!--</model>-->
		        <!--<actions>-->

		        <!--</actions>-->
		        <!--<reactions>-->

		        <!--</reactions>-->
		    <!--</fieldset>-->
		<!--</section>-->

		<footer data-widget="account-overlay" data-group="account-controller" class="overlay">
		    <p>
		        Powered by Collaborate &copy; Scott Byrns 2013
		    </p>
		</footer>

		</div>
		
		
		
		<section data-widget="virtual-entity-dao" data-group="virtual-entity-dao">
			<button data-widget="user-action" data-event="click" data-group="virtual-entity-dao" data-channel="create entity" data-message="farm">   
				Create Entity
			</button>
			<button data-widget="user-action" data-event="click" data-group="virtual-entity-dao" data-channel="read entity" data-message="plant">   
				Read Entity
			</button>
			<button data-widget="user-action" data-event="click" data-group="virtual-entity-dao" data-channel="update entity" data-message="field">   
				Update Entity
			</button>
			<button data-widget="user-action" data-event="click" data-group="virtual-entity-dao" data-channel="delete entity" data-message="crop">   
				Delete Entity
			</button>
			
			<button data-widget="user-action" data-event="click" data-group="voice" data-channel="speak-male" data-message="hello">   
				Speak
			</button>
			
		</section>
	
	


		
		<script>
		
 
		var DOMWindow = window;
		var DOMDocument = document;
		
		socket.on("connect", function () {
	
			console.log("Socket Connected.");
	
			window.$handle = function (group) {
				if (group == undefined) {
					throw new Error("A group identifier must be provided when handling messages.");
					return;
				}
				console.log("Registering handlers for group: " + group);
			
				socket.emit("register handler", {group:group});
			
				return {
					with: function (action) {
						console.log("Attaching callback method to group.");
						socket.on(group, function (data) {
							console.log(data);
							data.fromSever = true;
							// Foundation.MessageController.sendMessage(group, data);
							if (action === undefined) {
								return;
							}
							else {
								console.log("Forwarding socket message to callback.");
								if (data.channel && CLIENT_TALKS) {
									// $to("voice").say({channel:"speak-male", message:group + " ... " + data.channel});
								}
								action(data);
							}
						});
					}
				}
			}


	

	
			window.$to = function (group) {
				// socket.emit("register handler", {group:group});
				return {
					say: function (msg) {
						if (typeof msg === "object" && !(msg instanceof Array)) {
							console.clear();
							console.warn(localStorage.sessionId);
							msg.sessionId = localStorage.sessionId;
							console.log(msg);
						}
						if (msg.fromClient == true) {
							return;
						}
						socket.emit(group, msg);
						Foundation.MessageController.sendMessage(group, msg);
					}
				}
			}
	
	
			window.$with = function (controller) {
				console.log("With:" + controller);
				return {
					and: function (context) {
						console.log("And: " + context);
						return {
							resolve: function (requirement) {
								console.log("resolve:" + requirement);
								return {
									for: function (entity) {
										if (entity.fromClient == true) {
											return;
										}
										$to(controller).say({channel:requirement, data:entity, context:context});
										// socket.emit(controller, {channel:requirement, data:entity});
										// Foundation.MessageController.sendMessage(controller, entity, requirement);
									}
								}
							}
						}				
					}
				}
			}
			
		
			var WidgetFramework = function (DOMWindow, DOMDocument) {




				if (!DOMWindow.LiveWidgets) {
					var TemplateEngine = function () {
						/* Create the cache object */
						var cache = {},
						_template;
						/* Define the alias for the tmpl method and define the tmpl method */
						_template = function tmpl(template, data){
							/* Figure out if we're getting a template, or if we need to
							 load the template - and be sure to cache the result. */
							var fn = !/\W/.test(template) ? cache[template] = cache[template] || _template(template) :
							/* Generate a reusable function that will serve as a template
							 generator (and which will be cached). */
							new Function("obj",
							"var p=[],print=function(){p.push.apply(p,arguments);};" +
							/* Introduce the data as local variables using with(){} */
							"with(obj){p.push('" +
							/*  Convert the template into pure JavaScript */
							template.replace(/[\r\t\n]/g, " ").split("<?").join("\t").replace(/((^|\?>)[^\t]*)'/g, "$1\r").replace(/\t=(.*?)\?>/g, "',$1,'").split("\t").join("');").split("?>").join("p.push('").split("\r").join("\\'") + "');}return p.join('');");
							/* Provide some basic currying to the user */
							return data ? fn( data ) : fn;
						};
						return _template;
					}();
			
					var Warehouse = function () {
						this.store = DOMWindow.localstore;
					};
			
					var getProperty = function (propertyName) {
						this.say("this is the value of " + propertyName, this.model[propertyName]);
					};
			
					var setProperty = function (propertyName, value) {
						this.model[propertyName] = value;
						this.say("this is the value of " + propertyName, this.model[propertyName]);
					};
			
					var ManagedModel = function (model) {
						this.model = model;
						var self = this;
						// console.log(model);
						for (var property in model) {
							if (model.hadOwnProperty(property)) {
								console.log(property);
								self["get_" + property] = Helpers.bind(function (getProperty, property) {
									return function () {
										getProperty.apply(this, [property]);
									};
								}.apply(this, [getProperty, property]), this);

								self["set_" + property] = Helpers.bind(function (setProperty, property) {
									return function (value) {
										setProperty.apply(this, [property, value]);
									};
								}.apply(this, [setProperty, property]), this);
						
							}
						}
					};
			
					/**
					 * Class to manage and coordinate the communication between a pool of registered listeners.
					 * @returns undefined
					 */
					var MessageController = function () {
						this.listenerPool = {};
					};
					/**
					 * Register a new listener
					 * @param {String} key Group key name
					 * @param {String|Number} UID Unique value to register a callback
					 * @param {Function} callback Method to be called with a message.
					 * @returns undefined
					 */
					MessageController.prototype.registerListener = function (key, UID, callback) {
						if (!this.listenerPool[key]) {
							this.listenerPool[key] = {};

							$handle(key).with(function (message) {
								this.sendMessage(key, message);
							}.bind(this));
							
							this.listenerPool[key][Math.floor(Math.random() * new Date) + ""] = function (message) {
								message.sessionId = localStorage.sesisonId;
								socket.emit(key, message);
								// this.sendMessage(key, message);
							};

							// Attempting to handle the registration here causes the controller to fail.
							// Echo?
							// socket.emit("register handler", {group:group});
							// $handle(key);
						}
						this.listenerPool[key][UID] = callback;
					};
					/**
					 * Send a message to a listener pool
					 * @param {String} targetListener Group key name to send the message to.
					 * @param {Any} message Message to send to the target group.
					 * @returns undefined
					 */
					MessageController.prototype.sendMessage = function (targetListener, message) {
						// try {
							var target = this.listenerPool[targetListener];
							var hasBroadcastToSocket = false;
							for (callback in target) {
								// console.log(target[callback]);
								if (target.hasOwnProperty(callback)) {
									// console.log(message.channel)
									// if (!hasBroadcastToSocket) {
									// 	hasBroadcastToSocket = true;
									// 	console.warn("Sending message to socket. " + message.channel);
									// 	if (message.channel == new Object().toString()) {
									// 		
									// 	}
									// 	else {
										if (CLIENT_TALKS) {
											$to("voice").say({channel:"speak", message:message.channel});	
										}
									// $to("voice").say({channel:"speak", message:message.channel});											
									// 	}
									// 	$to(message.channel).say(message);
									// }
									this.callbacks = this.callbacks || {};
									if (!this.callbacks) {
										this.callbacks = {};
										this.callbacks[callback] = 0;
									}
									this.callbacks[callback] = this.callbacks[callback] || 0;
									this.callbacks[callback] += 1;
									
									// console.log(targetListener + " : " + message.channel + " has been called " + this.callbacks[callback] + " times.");
									// $to(targetListener).say(message);
									if (typeof target[callback] !== "function") {
										if (target[callback] != undefined) {
											alert(JSON.stringify(target[callback]));
										}
									}
									if (target[callback] != undefined) {
										target[callback](message);										
									}
								}
							}
						// }
						// catch (e) {
						//     console.warn("A message failed to send.");
						// 			                console.log(e);
						// }
					};
	
					MessageController = new MessageController();
	
					var Helpers = {
						/**
						 * Bind an execution context to a method and return it
						 * @param {Function} method Method to bind an execution context to.
						 * @param {Context} context Execution context to bind to method.
						 * @TODO Bind the context with a prototype like bind technique
						 */
						bind: function (method, context) {
							return function () {
								try {
									method.apply(context, arguments);
								}
								catch (e) {
									console.error(e);
								}
							};
						},
						/**
						 * Clone an object so that all properties are new instances of the objects
						 * rather than pointers to the original.
						 * @param {Object} from Object to clone
						 * @param {Context} scope Execution context to bind to all methods found
						 * in the object being cloned.
						 * @TODO Consider removing the execution context binding and creating a
						 * helper to do it. It falls out of the scope of "deep clone"ing but saves
						 * on lines of code. Is the trade off worth the unusal behavior?
						 */
						deepClone: function (from, scope) {
							var to = {};
							for (var i in from) {
								if (from.hasOwnProperty(i)) {
									if (typeof from[i] === 'object') {
										if (from[i] instanceof Array) {
											to[i] = [];
											for (var val in from[i]) {
												if (from[i].hasOwnProperty(val)) {
													to[i][val] = from[i][val];
												}
											}
										}
										else {
											to[i] = Helpers.deepClone(from[i], scope);
										}
									}
									else if (typeof from[i] === 'function' && scope) {
										to[i] = Helpers.bind(from[i], scope);
									}
									else {
										to[i] = from[i];
									}
								}
							}
							return to;
						},
						/**
						 * Check to make sure the controller does not have have any properties that will conflict with
						 * the widgets properties and method.
						 * @param {Object} controller Controller provided in an addWidget call.
						 * @returns {Boolean} True if the controller is fine, false if it will conflict with the widget.
						 */
						validateController: function (controller) {
							if (controller.reinit || controller.sendMessage || controller.model || controller.properties || controller.controller || controller.element || controller.behaviors || controller.reactions) {
								return false;
							}
							else {
								return true;
							}
						},
						/**
						 * Check for missing properties on a widget and add them.
						 * @param {Object} widget Widget to clean up.
						 * @returns {Object} a clean version of the widget
						 */
						cleanWidget: function (widget) {
							widget.constructor = widget.constructor || function () {};
							widget.reinit = widget.reinit || function () {};

							widget.behaviors = widget.behaviors || {};
							widget.reactions = widget.reactions || {};
							widget.properties = widget.properties || widget.model || {};

							widget.template = widget.template || widget.view || undefined;

							widget.model = widget.model || widget.properties || {};
							widget.properties = widget.model;
							widget.controller = widget.controller || {};
							
							return widget;
						},
						/**
						 * Create the widget constructor. We capture the model in the scope of the
						 * constroctur, add the element property, controller methods with scope
						 * correction, call the widget constructor in the scope of this constructor,
						 * register a listener for grouped widgets, and call reinit.
						 * @param {Object} widget Our widget we are creating a class for.
						 * @returns undefined
						 */
						buildWidgetConstructor: function (widget) {
							return function (element) {
								try {
									this.model = ManagedModel.call(this, Helpers.deepClone(widget.model, this));
								}
								catch(e) {
									this.model = Helpers.deepClone(widget.model, this);
								}
								this.properties = this.model;
								for (var i = 0, len = element.attributes.length; i < len; i += 1) {
									var name = element.attributes[i].name;
									if (name.indexOf('data-') > -1 && name !== 'data-widget-id' && name !== 'data-widget' && name !== 'data-template') {
										this.model[name.replace('data-', '')] = element.getAttribute(name);
										this.properties[name.replace('data-', '')] = element.getAttribute(name);
									}
								}
								this.element = element;
								this.behaviors = Helpers.deepClone(widget.behaviors, this);
								this.reactions = Helpers.deepClone(widget.reactions, this);
								this.controller = Helpers.deepClone(widget.controller, this);
						
								try {
									// console.error(widget.name);
									// console.error(this.element.childNodes);
									if (this.element.getElementsByTagName("pre").length > 0) {								
										alert("template");
										
										console.log(this.template)
										
										var cachedTemplates = [];									
								
										try {
											if (this.element.getElementsByTagName("pre")[0].getElementsByTagName("pre").length > 0) {
									
												var nestedTemplates = this.element.getElementsByTagName("pre")[0].getElementsByTagName("pre");
									
												for (var i = 0; i < nestedTemplates.length; i += 1) {
													cachedTemplates[i] = nestedTemplates[i].innerHTML;
													nestedTemplates[i].innerHTML = "{CACHEID=" + i + "}";
												}
											}
										}
										catch (ignore) {
											// No nested templates were found.
										}
										console.log(this.template)
								
								
										this.template = this.element.getElementsByTagName("pre")[0].innerHTML;
										console.log(this.template);
										
										try {
											this.template = this.template.split("&lt;%").join("<?").split("%&gt;").join("?>").split("&lt;").join("<").split("&gt;").join(">");
										}
										catch (e) {
											console.error(e);
										}
										
										console.log(this.template);
								
										for (var i = 0; i < cachedTemplates.length; i += 1) {
											this.template = this.template.replace("{CACHEID="+i+"}", cachedTemplates[i]);
										}
										// alert(this.template);
									}							
								}
								catch (e) {
									console.error(e);
									/* Muck the error. If we dont have a template we dont have a template. */
								}
						
								// socket.emit("register handler", {group:this.element.getAttribute("data-widget-id")});
						
								// $handle(this.element.getAttribute("data-widget-id")).with(Helpers.bind(function (msg) {
								// 	console.log("\n\n**********DATA DID RETURN*******\n\n");
								// 	$to("logger").say(msg);
								// 	this.sendMessage(msg);
								// }, this));
						
								// socket.emit("register handler", {group:this.element.getAttribute("data-widget-id")});

								widget.constructor.call(this);
								// console.log(this);
								if (this.model.group) {

									
									var callback = Helpers.bind(function (messageObject) {
										// console.error(messageObject);
										// socket.emit(this.model.group, messageObject);
								
										for (var index in this.behaviors) {
											if (index === messageObject.channel) {
												// console.log(typeof this.behaviors[index]);
												if (typeof this.behaviors[index] != "function") {
													this.reactions[this.behaviors[index]](messageObject.message);
												}
												else {
													this.behaviors[index](messageObject.message);													
												}

											}
										}

										for (var index in this.reactions) {
											// console.error(this);
											// console.error(this.model.group, " : ", messageObject.channel, index);

											if (index === messageObject.channel) {

												if (typeof this.reactions[index] != "function") {
													if (typeof this.reactions[index] != "string") {
														if (this.reactions[index].group) {
															// Skip over it. This handler is reserved for external input.
														}
													}
													else {
														this.behaviors[this.reactions[index]](messageObject.message);	
													}
												}
												else {
													// console.error(messageObject);
													this.reactions[index](messageObject.message);	
												}
											}
										}
										
										this.handleMessage(messageObject.message, messageObject.channel);
									}, this);
									
									var otherCallback = Helpers.bind(function (message) {
										MessageController.sendMessage(this.model.group, message);										
									}, this);
									
									// socket.groups = socket.groups || {};
									// if (socket.groups[this.model.group] == true) {
									// 
									// }
									// else {
									// 	socket.groups[this.model.group] = true;
									// 	// socket.emit("register handler", {group:this.model.group});									
									// 	$handle(this.model.group).with(otherCallback);
									// }
									
									// $handle(this.element.getAttribute("data-widget-id")).with(otherCallback);
									// $handle("voice-input").with(otherCallback);
									// Foundation.MessageController.addListener("voice", Math.floor(Math.random() * new Date()), otherCallback);
									
									for (var index in this.reactions) {

										// if (index === messageObject.channel) {
											if (typeof this.reactions[index] != "function") {
												if (typeof this.reactions[index] != "string") {
													if (this.reactions[index].group) {
														// Register a handler with the specific callback that can handler it.

														Helpers.bind(function (group, channel) {
															console.log("Binding widget aspect: " + group + " " + channel);
															MessageController.registerListener(group, Math.floor(Math.random() * new Date()), Helpers.bind(function (message) {
																// Return first to prevent a scope step in then step out. If we can send the message we dont have to change scope to do it. If we cant then we make 1 change then exit the scope. This should be 1 less operation either route through code. Microseconds faster for a few extra bytes.
																if (message.channel != channel) {
																	return;
																}

																this.behaviors[this.reactions[channel].behavior](message.message);
															}, this));
														}, this)(this.reactions[index].group, index);
														
													}
												}
											}
										// }
									}
									
									
									MessageController.registerListener(this.model.group, Math.floor(Math.random() * new Date()), callback);
								}
				
								this.reinit();
								this.say("widget did render");
							};
						}
					};
	
					var Augments = {
						broadcastMessage: function (group, channel, message) {
							if (!channel && typeof message === "String") {

								MessageController.sendMessage(group, {
									sessionId: localStorage.sessionId,
									message: {},
									channel: message,
									context: this.element.getAttribute("data-widget-id")
								});
						
							}
							else {
								MessageController.sendMessage(group, {
									sessionId: localStorage.sessionId,
									message: message,
									channel: channel,
									context: this.element.getAttribute("data-widget-id")
								});							
							}							
						},
						/**
						 * Method to send a message to a registered listener pool.
						 * @param {All} message Message to be sent to registered listeners, this can be any type of object.
						 * @param {String} channel Channel that can be used to filter messages for requests.
						 */
						sendMessage: function (message, channel) {
							if (!channel && typeof message === "String") {
								// if (CLIENT_TALKS) {
								// 	$to("voice").say({channel:"speak", message:message});	
								// }
								// console.log();
								MessageController.sendMessage(this.model.group, {
									sessionId: localStorage.sessionId,
									message: {},
									channel: message,
									context: this.element.getAttribute("data-widget-id")
								});
						
								// $to(this.model.group).say({
								// 	message: {},
								// 	channel: message,
								// 	context: this.element.getAttribute("data-widget-id")
								// });
						
								// // console.log(this.element.getAttribute("data-widget-id"));
	// 							$handle(this.element.getAttribute("data-widget-id")).with(Helpers.bind(function (msg) {
	// 								// $to("logger").say(msg);
	// 								// this.element.getAttribute("data-widget-id")
	// 								console.log("Widget Callback:");
	// 								console.log(msg);
	// 								MessageController.sendMessage(this.model.group, {
	// 									message: {},
	// 									channel: msg,
	// 									context: this.element.getAttribute("data-widget-id")
	// 								});
	// 							}, this));	
								// $handle(this.element.getAttribute("data-widget-id")).with(Helpers.bind(function (messageObject) {
								// 	console.log("Message callback for widget with id: #" + this.element.getAttribute("data-widget-id"));
								// 	this.sendMessage(messageObject, this.model.group);
								// 	// $to("logger").say({message:messageObject, group: this.model.group});
								// }, this));
						
								// .with(function (message) {
								// 	$to("logger").say("Translating: " + message.translate);
								// });
								// 
								// MessageController.registerListener(this.element.getAttribute("data-widget-id"), this.element.getAttribute("data-widget-id"), Helpers.bind(function (messageObject) {
								// 	this.handleMessage(messageObject, this.model.group);
								// }, this));
						
						
								// $to(channel).say(message);
								// Foundation.MessageController.sendMessage(group, msg);
						
								// $with(group).and(this.element.getAttribute("data-widget-id")).resolve(channel).for(message);
						
							}
							else {
								MessageController.sendMessage(this.model.group, {
									sessionId: localStorage.sessionId,
									message: message,
									channel: channel,
									context: this.element.getAttribute("data-widget-id")
								});							
							}

						},
						/**
						 * Replace the innerHTML of the widget element with a rendered template
						 * @returns undefined
						 */
						renderTemplate: function () {
							this.element.innerHTML = TemplateEngine(this.template, this.properties);
						}
					};
					/**
					 * LiveWidgets
					 * @param {window} DOMWindow window global reference
					 * @param {document} DOMDOcument DOM Document
					 */
					var LiveWidgets = function (DOMWindow, DOMDocument) {
						this.widgets = {};
						this.widgetInstances = {};
						this.sessionId = undefined;
					};
					/**
					 * Add a new widget module to the widgets object.
					 * @param {Object} widgetModule Object containing the widget description.
					 */
					LiveWidgets.prototype.addWidget = function (widgetModule) {
						console.log("Creating new widget named: " + widgetModule.name);
						widgetModule = Helpers.cleanWidget(widgetModule);
		
						if (!widgetModule.name) {
							return false;
						}
		
						if (!Helpers.validateController(widgetModule.controller)) {
							return false;
						}
		
						this.widgets[widgetModule.name] = Helpers.buildWidgetConstructor(widgetModule);
		
						this.widgets[widgetModule.name].prototype.handleMessage = widgetModule.controller.handleMessage || function () {};
		
						this.widgets[widgetModule.name].prototype.template = widgetModule.template || widgetModule.view || false;
						this.widgets[widgetModule.name].prototype.sendMessage = Augments.sendMessage;
						this.widgets[widgetModule.name].prototype.broadcastMessage = Augments.broadcastMessage;
						this.widgets[widgetModule.name].prototype.say = Augments.sendMessage;
						this.widgets[widgetModule.name].prototype.reinit = (function (reinit) {
							return function () {
								if (this.template) {
									this.renderTemplate();
								}
								reinit.call(this);
							};
						})(widgetModule.reinit);
		
						this.widgets[widgetModule.name].prototype.renderTemplate = Augments.renderTemplate;
					
					};
					/**
					 * Extend an existing widget.
					 * @param {String} widgetName Existing widget to be extended
					 * @param {Object} extention Widget object to extend the existing widget with.
					 */
					LiveWidgets.prototype.extendWidget = function (widgetName, extention) {
		
						if (!extention.reinit) {
							extention.reinit = this.widgets[widgetName].prototype.reinit;
						}
		
						extention = Helpers.cleanWidget(extention);
		
						if (!extention.name) {
							return false;
						}
		
						if (!Helpers.validateController(extention.controller)) {
							return false;
						}
		
						this.widgets[extention.name] = function (element) {
							this.widgets[widgetName].call(this, element);
							extention.constructor.call(this, element);
						};
		
						this.widgets[extention.name].prototype = this.widgets[widgetName].prototype;
		
						this.widgets[extention.name].prototype.handleMessage = extention.controller.handleMessage || this.widgets[widgetName].prototype.handleMessage;
						this.widgets[extention.name].prototype.reinit = (function (reinit) {
							return function () {
								if (this.template) {
									this.renderTemplate();
								}
								reinit.call(this);
							};
						})(extention.reinit);
					};
					/**
					 * Set every thing up to prepare to create an instance of the widget.
					 * @param {DOM} element DOM element that a widget will be deployed for.
					 */
					LiveWidgets.prototype.initializeWidget = function (element) {
						if (!this.widgets[element.getAttribute('data-widget')]) {
							return false;
						}
						var UID = Math.floor(new Date()*Math.random());
						element.setAttribute('data-widget-id', UID);
						this.widgetInstances[UID] = this.instantiateWidget(element, element.getAttribute('data-widget'));
					};
					/**
					 * Return a new isntance of a widget by name attached to the specified element.
					 * @param {DOM} element DOM element to attach the widget to.
					 * @param {String} name Name of the widget class that will be instantiated
					 */
					LiveWidgets.prototype.instantiateWidget = function (element, name) {
						// try {
							return new this.widgets[name](element);
						// }
						// catch (e) {
						//     console.warn(name +" failed to load.");
						// 	console.error(e);
						// 	/* Defer widget here */
						// }
					}
	
					LiveWidgets = new LiveWidgets(DOMWindow, DOMDocument);
					/**
					 * Class for managing the scanning of the DOM document.
					 * @param {Number} interval Interval length in MS to time successive
					 * scans of the document.
					 */
					var Monitor = function (interval) {
						this.interval = interval;
						this.monitor = {};
						this.domSize = 0;
					};
					/**
					 * Search the document for elements with the data-widget attribute that do
					 * not also have the data-widget-id attribute. Call LiveWidgets.initializeWidget
					 * with a DOM element that matches the above noted conditions.
					 * @returns undefined
					 */
					Monitor.prototype.searchForElements = function (override) {
						var domElements = DOMDocument.getElementsByTagName('*');
						if (domElements.length == this.domSize && !override) {
							return false;
						}
						this.domSize = domElements.length;
						for (var el = 0, len = domElements.length; el < len; el += 1) {
							// try {
								if (domElements[el] && domElements[el].getAttribute('data-widget') && !domElements[el].getAttribute('data-widget-id')) {
									var node = domElements[el];
									var canLoad = false;
									var canNotLoad = false;
									var isNestedTemplate = false;
									var parentIsDefered = false;
									while(node.parentNode) {
										node = node.parentNode;
										if ("[object HTMLPreElement]" == node.toString()) {
											isNestedTemplate = true;
										}
										if ("[object HTMLDocument]" == node.toString()) {
											canLoad = true;
										}
										else if(node.getAttribute("data-widget-defered") && node.getAttribute("data-widget-defered") == "true") {
											parentIsDefered = true;
											canLoad = false;
											domElements[el].setAttribute("data-widget-defered", "true");
										}
										
										try {
											var parentIsInstantiatedFirst = (node.getAttribute('data-widget') && node.getAttribute('data-widget-id'));
											var parentIsTheDocument = (node.toString() == "[object HTMLHtmlElement]");
										}
										catch (e) {
											// NOP
										}
										if (parentIsInstantiatedFirst || parentIsTheDocument || !parentIsDefered) {
											try {
												canLoad = true;
											}
											catch (e) {
												console.error(e);
											}
										}
									}
									
									if (domElements[el].getAttribute('data-session-required')) {

										if (LiveWidgets.sessionId != undefined) {
											console.log("Session not found.");
										}
										else {
											canLoad = false;
										}
									}

									if (!canLoad || (domElements[el].parentNode.toString() == "[object HTMLPreElement]")) {
										domElements[el].setAttribute("data-widget-defered", "true");
										console.warn("Defering widget loading.");
									}
									else {
										if (!isNestedTemplate && !parentIsDefered) {
											// console.log("Initializing Widget: " + domElements[el].getAttribute("data-widget"));
											domElements[el].setAttribute("data-widget-defered", "false");
											LiveWidgets.initializeWidget(domElements[el]);	
										}
									}
								}
							// }
							// catch (e) {
							// 	console.error(e);
							// };
						}
					};
					/**
					 * Start scanning the document for widgets.
					 * @returns undefined
					 */
					Monitor.prototype.startScanning = function () {
						this.searchForElements.call(this);
						try {
							document.addEventListener('DOMNodeInsertedIntoDocument', Helpers.bind(this.searchForElements), true);
							this.monitor = setInterval(Helpers.bind(this.searchForElements, this), this.interval);
						}
						catch (e) {
							clearInterval(this.monitor);
							this.monitor = setInterval(Helpers.bind(this.searchForElements, this), this.interval);
						}
					};
					/**
					 * Stop scanning the document for widgets.
					 * @returns undefined
					 */
					Monitor.prototype.stopScanning = function () {
						clearInterval(this.monitor);
					};
	
					Monitor = new Monitor(33);
					console.log("Starting to scan for widgets.");
					setTimeout(function () {
						Monitor.startScanning();
					}, 0);
	
					DOMWindow.LiveWidgets = {
						addWidget: Helpers.bind(LiveWidgets.addWidget, LiveWidgets),
						extendWidget: Helpers.bind(LiveWidgets.extendWidget, LiveWidgets),
						stopScanning: Helpers.bind(Monitor.stopScanning, Monitor),
						startScanning: Helpers.bind(Monitor.startScanning, Monitor),
						sendMessage: Helpers.bind(MessageController.sendMessage, MessageController),
						registerSession: Helpers.bind(function (session) {
							LiveWidgets.sessionId = session;
							Monitor.searchForElements(true);
						}, LiveWidgets)
					};
	
				}

			};
			
			WidgetFramework(DOMWindow, DOMDocument);


			LiveWidgets.addWidget({
				name: 'user-action',
				model: {
					event: ''
				},
				controller: {
					dispatchMessageToGroupedWidgets: function (event) {
						event.stopPropagation();
						this.sendMessage(this.model.message, this.model.channel);
					}
				},
				reinit: function () {
					this.element.removeEventListener(this.model.event, this.controller.dispatchMessageToGroupedWidgets);
					this.element.addEventListener(this.model.event, this.controller.dispatchMessageToGroupedWidgets, true);
				}
			});
		
			LiveWidgets.addWidget({
				name: 'event',
				model: {
					event: ''
				},
				controller: {
					dispatchMessageToGroupedWidgets: function (event) {
						// event.stopPropagation();
						setTimeout(function () {
							this.sendMessage(this.model.message, this.model.channel);
						}.bind(this), 0);
					}
				},
				reinit: function () {
					// this.element.removeEventListener(this.model.event, this.controller.dispatchMessageToGroupedWidgets);
					// this.element.addEventListener(this.model.event, this.controller.dispatchMessageToGroupedWidgets, true);
					this.controller.dispatchMessageToGroupedWidgets();
				}

			});

			LiveWidgets.addWidget({
				name: 'user-input',
				model: {
					event: "keyup",
					name: "",
					type: ''
				},
				constructor: function () {
					if (this.model["omit-label"]) {
						return;
					}
					var asdf = document.createElement("label");
					this.element.parentNode.insertBefore(asdf, this.element);
					asdf.innerHTML = this.model.channel;
					
					this.element.addEventListener(this.model.event, this.controller.dispatchMessageToGroupedWidgets, true);
				},
				controller: {
					dispatchMessageToGroupedWidgets: function (event) {
						event.stopPropagation();
						this.sendMessage(this.element.value, this.model.channel);
					}
				},
				reinit: function () {
					// this.element.removeEventListener(this.model.event, this.controller.dispatchMessageToGroupedWidgets);
					// this.element.addEventListener(this.model.event, this.controller.dispatchMessageToGroupedWidgets, true);
					// this.say("widget did render");
				}
			});


			LiveWidgets.addWidget({
				name: 'label-input',
				model: {
					event: "keyup",
					name: "",
					type: ''
				},
				constructor: function () {
					if (this.model["omit-label"]) {
						return;
					}
					var asdf = document.createElement("label");
					this.element.parentNode.insertBefore(asdf, this.element);
					asdf.innerHTML = this.model.channel;
					
					this.element.addEventListener(this.model.event, this.controller.dispatchMessageToGroupedWidgets, true);
					
					
				},
				controller: {
					dispatchMessageToGroupedWidgets: function (event) {
						event.stopPropagation();
						try {
							if (event.keyCode == 27) {
								this.model.suggestion = "";
								this.model.createNext = true;
								try {
									if (this.element.parentNode.getElementsByClassName("label-overlay")[0] != null) {
										this.element.parentNode.getElementsByClassName("label-overlay")[0].innerHTML = "";
										return;
									}
								}
								catch (e) {
									console.error(e);
								}
							}
							else if (event.keyCode == 13) {
								if (this.model.createNext) {
									this.model.suggestion = "";
									this.model.createNext = false;
								}
								if (this.element.value != this.model.suggestion && this.model.suggestion != "") {
									this.element.value = this.model.suggestion;
									this.broadcastMessage("nodary-controller", "create label", this.element.value);
									this.sendMessage(this.element.value, this.model.channel);
									this.broadcastMessage("nodary-controller", "load label", this.element.value);
								}
								else {
									this.broadcastMessage("nodary-controller", "create label", this.element.value);
									this.sendMessage(this.element.value, this.model.channel);
									this.broadcastMessage("nodary-controller", "load label", this.element.value);									
								}

							}
							else {
								this.model.createNext = false;
								this.sendMessage(this.element.value, this.model.channel);
								this.broadcastMessage("nodary-controller", "load label", this.element.value);
							}
						}
						catch (e) {
							this.sendMessage(this.element.value, this.model.channel);
							this.broadcastMessage("nodary-controller", "load label", this.element.value);
						}
					}
				},
				behaviors: {
					"render label": function (message) {
						if (message.value == undefined) {
							message.value = "";
						}
						try {
							this.model.suggestion = message.value;
							if (this.element.parentNode.getElementsByClassName("label-overlay")[0] != null) {
								this.element.parentNode.getElementsByClassName("label-overlay")[0].innerHTML = message.value;
								return;
							}
						}
						catch (e) {
							console.error(e);
						}
						var asdf = document.createElement("label");
						asdf.setAttribute("class", "label-overlay");
						this.element.parentNode.insertBefore(asdf, this.element);
						asdf.innerHTML = message.value;
					}
				},
				reactions: {
					"label loaded": {
						group: "nodary-controller",
						behavior: "render label"
					}
				},
				reinit: function () {
					this.element.removeEventListener(this.model.event, this.controller.dispatchMessageToGroupedWidgets);
					this.element.addEventListener(this.model.event, this.controller.dispatchMessageToGroupedWidgets, true);
					// this.say("widget did render");
				}
			});
			
		
		
		
		
			// $handle("voice");
		
		
		
				
		
		
			var Action = {

			};
			var Procedure = {};
		
			Procedure["do redraw view"] = function (message) {
				this.reinit();
			};
		
			Procedure["do add property to property list"] = function (message) {
				alert(message);
				this.properties.properties.push(message);
				this.say("the view needs to be redrawn");
			}
		
			Procedure["do create new behavior dialog"] = function (message) {
				window.alert("Add a new behavior");
			};
		
			Procedure["do show widget"] = function (message) {
				this.element.style.display = "block";
			};
		
			Procedure["do hide widget"] = function (message) {
				this.element.style.display = "none";
			};
		
			Action["show create new propery dialog"] = function (message) {
				this.say("show create new property dialog");
			};
		
			Action["redraw view"] = function (message) {
				this.say("redraw view");
			};
		
			Action["add new property to property list"] = function (message) {
				this.say(message, "add new property to property list");
			};
		
			Action["show create new behavior dialog"] = function (message) {
				window.alert("Behavior was added.");
			};
		
			Action["hide create new property dialog"] = function (message) {
				this.say("hide create new property dialog");
			};
		
			Action["create new property"] = function (message) {
				var inputs = this.element.getElementsByTagName("input");
				var output = {};
				for (var i = 0; i < inputs.length; i +=1 ) {
					output[inputs[i].name.toLowerCase()] = inputs[i].value;
				}
				console.log(output);
				this.say(output, "user did create a new property");
				this.say("hide create new property dialog");
			};
				
			Action["hide create new property dialog"] = function (message) {
				this.say("hide create new property dialog");
			};
		
		
			LiveWidgets.addWidget({
				name: "list-element",
				properties: {
					"label": "Loading..."
				},
				view: '<?=label ?>',
				behaviors: {
				
				},
				reactions: {
				
				}
			}),
		
		
		
			LiveWidgets.addWidget({
				name: "table",
				properties: {
					head: {
						title: "Header",
						description: ""
					},
					body: {

					},
					foot: {
					
					}
				}
			})



			LiveWidgets.addWidget({
				name: "form",
				properties: {
					fields: [
					],
					render: function (field) {
						return '<label>' + field.label + '</label><input name="' + field.label + '" type="text" />';
					}
				},
				constructor: function () {
					try {
						if (this.element.getElementsByTagName("code")[0] !== "undefined") {
							this.model = this.properties = JSON.parse(this.element.getElementsByTagName("code")[0].innerHTML);
						}
					}
					catch (e) {
						console.log("failed to get model from code block");
						console.error(e);
					}
					this.say("the view needs to be redrawn");
				},
				behaviors: {
					"redraw view": Procedure["do redraw view"],
					"dialog data model": function (message) {
						alert('asdf');
						console.log(message);
						this.fields = message;
						this.say("redraw view");
					}
				},
				reactions: {
					"the view needs to be redrawn": Action["redraw view"]			
				}
			});
			
			
			LiveWidgets.addWidget({
				name: "my-records-controller",
				properties: {
					title: "Records Controller"
				},
				behaviors: {
					"show add record dialog": function (message) {
						$to("voice").say({channel:"speak", message: "Show add record dialog"});
					}
				},
				reactions: {
					"add a record": "show add record dialog"
				}
			})
			

		
		
			LiveWidgets.addWidget({
				name: "account-controller",
				properties: {
					username: "scott",
					password: "test",
					didLogin: false
				},
				
				constructor: function () {

				},
				
				reinit: function () {
					if (localStorage.sessionId) {
						console.log(localStorage.sessionId);
						this.say("existing session found", "existing session found");
						this.say("user was logged in", "user was logged in");
						this.say("hide the overlay", "hide the overlay");													
						setTimeout(function () {
							this.say("user was logged in", "user was logged in");
							this.say("hide the overlay", "hide the overlay");
							// LiveWidgets.registerSession(localStorage.sessionId);
							// LiveWidgets.sendMessage("activities", {channel:"go-to-my-records", message:"go-to-my-records"});
						}.bind(this), 300);
					}	
				},
				
				behaviors: {
					
					
					"user did ask to log in": function (message) {
						console.log("Logging in user.");
						this.say(this.properties, "login user");
					},
					"login": function (message) {
						if(this.properties.didLogin) {
							
						}
						else {
							this.properties.didLogin = true;
							this.say("user did ask to log in");							
						}

					}
				},
				reactions: {
					"username": function (message) {
						this.model.username = message;
					},
					"password": function (message) {
						this.model.password = message;
					},
					"The password you provided is not valid.": function (message) {
						this.element.innerHTML = message;
					},
					"user was logged in": function (message) {
						
						if (typeof message !== "string") {
							// console.log(message);
							this.model.username = message.name.value;
							this.model.password = message.password;
							this.model.user = message;
						
							localStorage.userid = message.id;
							localStorage.sessionId = message.session.sessionID.id;
						
							LiveWidgets.registerSession(message.session.sessionID.id);							
						}
						else {
							LiveWidgets.registerSession(localStorage.sessionId);
						}
						

						setTimeout(function () {LiveWidgets.sendMessage("activities", {channel:"go-to-my-records", message:"go-to-my-records"});}, 0);
												// 
						// 
						// // console.log("The user was logged in." + (new Date() - this.model.start));
						// this.element.innerHTML = "Welcome, " + this.model.username + ". You are now logged in. Your token is: #" + message.id;
						// 
						// clearInterval(this.model.interval);
						// 
						// this.model.interval = setInterval(function () {
						// 	
						// 	if ((this.element.offsetHeight <= 11)) {
						// 		
						// 		this.element.style.display = "none";
						// 		clearInterval(this.model.interval);
						// 		
						// 	}
						// 	
						// 	this.element.style.height = (this.element.offsetHeight - 13) + "px"; 
						// 	
						// }.bind(this), 33);
						// 
					}
				}
			});
			
			LiveWidgets.addWidget({
				name: 'account-overlay',
				properties: {
					name:"Overlay"
				},
				behaviors: {
					"existing session found": function () {
						$(this.element).html("Session found. Loading...");
					},
					"user was logged in": function () {
						$(this.element).removeClass("overlay");
					}
				},
				reactions: {
					"hide the overlay": function () {
		                $(this.element).css({
		                    zIndex:"0 !important",
		                    top:"auto !important",
		                    height:"75px !important",
		                    background: "#333 !important"
		                });
					}
				}
			});
		
			LiveWidgets.addWidget({
				name: 'create-dialog',
				properties: {
					title: "Create Property",
					description: "Add information about what composes your entity."
				},
				behaviors: {
					"show create new property dialog": Procedure["do show widget"],
					"hide create new property dialog": Procedure["do hide widget"]
				},
				reactions: {
					"widget did render": Action["hide create new property dialog"],
					"user did press the save button": Action["create new property"],
					"user did press the cancel button": Action["hide create new property dialog"]
				}
			});
			
			/*
{
  "name": "create-dialog",
  "properties": {
    "title": "Create Property",
    "description": "Add information about what composes your entity."
  },
  "behaviors": {
    "show create new property dialog": 
      "do show widget"
    ,
    "hide create new property dialog": 
      "do hide widget"
    
  },
  "reactions": {
    "widget did render": 
      "hide create new property dialog"
    ,
    "user did press the save button": 
      "create new property"
    ,
    "user did press the cancel button": 
      "hide create new property dialog"
    
  }
}
			*/
			
			/*
			
				LiveWidgets.createWidget("json-table", model, element);
			
				createWidget {
					this.element = document.createElement(element || "seciton");
				}
			
			*/
			LiveWidgets.addWidget({
				name: "records-list",
				properties: {
					title: "Records List",
					description: "List of records."
				},
				behaviors: {
					"search results": function (message) {
							this.element.innerHTML = "";				
							this.element.innerHTML = JSON.toForm(message);		
						// if (message.length > 0) {
						// 
						// 	for (var i = 0; i < message.length; i += 1) {
						// 		this.element.innerHTML = this.element.innerHTML + "<br />" + JSON.stringify(message[i]);
						// 		
						// 	}
						// }
					}
				},
				reactions: {
					
				}
			});
		
		
			LiveWidgets.addWidget({
				name: 'entity-builder',
				properties: {
			        entityName: "Foundation",
					properties: [],
					behaviors: [],
					reactions: []
				},

				behaviors: {
					"register your instance id": function (message) {
						this.model.id = this.element.getAttribute("data-widget-id");
						this.say(this.model, "instance id");
					},
					"show create new behavior dialog": Procedure["do create new behavior dialog"],
					"add new property to property list": Procedure["do add property to property list"],
					"redraw view": Procedure["do redraw view"]
				},
				reactions: {
					"user did press the add property button": Action["show create new propery dialog"],
					"the view needs to be redrawn": Action["redraw view"],
					"user did create a new property": Action["add new property to property list"],
					"a user did create a new behavior": Action["show create new behavior dialog"]
				}
			});




			LiveWidgets.addWidget({
				name: 'call-to-action-controls',
				properties: {
					key: "value"
				},
				controller: {
					setControls: function (controls) {
									$(this.element).html("");
						for (var i = 0; i < controls.length; i += 1) {
							var button = $("<button />");

							try {
								button.addClass(controls[i].type)
								.html(controls[i].label).click(function (action, group) {
									this.sendMessage(action);
									if (group !== undefined) {
									    LiveWidgets.sendMessage(group, {channel:action, message:{}});
									}
								}.bind(this, controls[i].action, controls[i].outboundGroup));
					
								$(this.element).append(button);
							}
							catch (e) {
								console.error(e);
							}
					
							// $(this.element).add()
						}
			

					},
					handleMessage: function (channel, message) {
						// console.log(arguments);
						if (channel == "set-controls") {
							this.controller.setControls(message);
						}
			
					}
				}
			});


			LiveWidgets.addWidget({
				name: 'call-to-action-configuration',
				properties: {
					key: "value"		
				},
				controller: {
					handleMessage: function (channel, message) {
						if (channel == "share your configuration" && message == this.model.for) {
							try {
								var controls = [];
								$(this.element).find("figure").each(function (index, element) {
									var control = {
										action: element.getAttribute("data-action"),
										type: element.getAttribute("data-type"),
										label: element.getAttribute("data-label"),
			                            outboundGroup: element.getAttribute("data-outbound-group")
									};
			
									controls.push(control);
			
								});
							}
							catch (e) {
								console.error(e);
							}
				
							console.log(controls);

					this.sendMessage("set-controls", controls);				
						}
					}
				}
			});








			LiveWidgets.addWidget({
				name: 'activity-controller',
				properties: {
							key: "value"
				},
				constructor: function () {
					setTimeout(function () {
									LiveWidgets.sendMessage("call-to-action", {channel:"my-records", message:"share your configuration"});
					}, 0);
				},
				controller: {

					handleMessage: function (channel, message) {
						// console.log(channel);
						try {
							message = message || channel || "";
							if (message.indexOf("go-to-") > -1) {
								// console.log(arguments);
								this.controller.showSpace(message.replace("go-to-", ""));
							}
						}
						catch (e) {
							// NOP
						}
					},
		
					showSpace: function (name) {
						$(".activity-view").hide();
						$("#" + name).show();
						LiveWidgets.sendMessage("call-to-action", {channel:name, message:"share your configuration"});
					}

				}
			});










			LiveWidgets.addWidget({
				name: 'activity-title',
				properties: {
							key: "value"
				},
				constructor: function () {
					// setTimeout(function () {
					// 	LiveWidgets.sendMessage("activities", {channel:"go-to-my-records", message:"go-to-my-records"});
					// }, 0);
				},
				controller: {
					allWordsToLeadingUpper: function( str ) {
						return str.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
					},
		
					handleMessage: function (channel, message) {
						try {
							message = message || "";
							if (message.indexOf("go-to-") > -1) {
											console.log(arguments);
								this.controller.showSpace(message.replace("go-to-", ""));
							}
						}
						catch (e) {
							// NOP
						}
					},
		
					showSpace: function (name) {
						name = name.replace("-", " ");
						name = name.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
						$(this.element).html(name);
					}
				}
			});

			LiveWidgets.addWidget({
				name: 'navigation-controller',
				properties: {key:"value"},
				behaviors: {
					"swith button": function (message) {
						$("li", this.element).each(function (data) {
							console.log(data);
						}.bind(this));
					}
				},
				controller: {
					setActiveButton: function (button) {
						$("li", this.element).removeClass("active");
						$("li[data-message=" + button + "]", this.element).addClass("active");
					},
					handleMessage: function (message, channel) {
						try {
							if(message.indexOf("go-to") == 0) {
								this.controller.setActiveButton(message);
							}
							if (message == "convert toolbar to icons") {
								$(this.element).find("li").each(function () {
									$(this).addClass("icon");
								});
							}
						}
						catch(e) {
							// NOP
						}
					}
				}
			});




			LiveWidgets.addWidget({
				name: "voice-input",
				properties: {
					key:"value",
					recognition: ""
				},
constructor: 				 function (message) {
					    this.properties.recognition = new webkitSpeechRecognition();
					     this.properties.recognition.continuous = true;
					     this.properties.recognition.interimResults = true;
						 this.properties.lastResult = new Date();
						 this.properties.lastWords = [];
					     this.properties.recognition.onstart = function() {
							 // $to("voice").say({channel:"speak", message: ""});
						 }.bind(this);
					     this.properties.recognition.onresult = function(event) {
							 // $to("voice").say({channel:"speak", message: "user did say something"});
							 setTimeout(function () {
								 if (new Date() - this.properties.lastResult < 600) {
									 return;
								 }
								 this.properties.lastResult = new Date();
								 
								 var result = event.results[event.results.length - 1][0].transcript;
								 console.log(event.results[event.results.length - 1][0].transcript);
								 for (var word = 0; word < this.properties.lastWords.length; word += 1) {
								 	result = result.replace(this.properties.lastWords[word], "");
									result = result.replace("  ", " ");
								 }
								 this.properties.lastWords = result.split(" ");
								 
								 var uniqueNames = [];
								 for (var i = 0; i < this.properties.lastWords.length; i += 1) {
									 if ($.inArray(this.properties.lastWords[i], uniqueNames) === -1) {
										 uniqueNames.push(this.properties.lastWords[i]);
									 }
								 }
								 
								 this.properties.lastWords = uniqueNames;
								 result = uniqueNames.join(" ");
								 
								 console.log(result);
								 
								 if (result.length > 50) {
									 return;
								 }
								 
								 this.say(result);
								 // $to("voice").say({channel:"speak", message: result});
								 // this.say(event.results[0][0].transcript);
								 // $to(this.properties.group).say({channel:event.results[0][0].transcript, message: event.results[0][0].transcript});
								 // this.properties.recognition.stop();
							 }.bind(this), 0);
						 }.bind(this);
					     this.properties.recognition.onerror = function(event) {
							 // $to("voice").say({channel:"speak", message: "failed to listen to user"});
						 }.bind(this);
					     this.properties.recognition.onend = function() {
							 							 // this.properties.recognition.start();
							 // $to("voice").say({channel:"speak", message: "no longer listenting to user"});
						 }.bind(this);
						 this.properties.recognition.start();
						 console.log(this.properties.recognition);
					},
				behaviors: {
					
				},
				reactions: {
					"user did press activate audio button": function (message) {
						try {
							this.properties.recognition.start();
						}
						catch (e) {
							this.properties.recognition.stop();
							this.properties.recognition.start();
						}
					}
				}
			});

			LiveWidgets.addWidget({
				name: "settings-controller",
				properties: {
					title: "Settings"
				},
				behaviors: {
					
				},
				reactions: {
					"here are the settings you requested": function (message) {
						console.warn(message);
						
					}
				}
			});

			LiveWidgets.addWidget({
				name:"nodary-controller",
				properties: {
					title: "Nodary Controller"
				},
				behaviors: {
					"create new nodary": function (message) {
						$to("nodary-controller").say({channel:"create nodary", message:{
						    "name": {
						        "value": message,
						        "name": null
						    },
						    "author": {
								"id": localStorage.userid,
						        "name": {
						            "value": "scott",
						            "name": null
						        },
						        "firstName": null,
						        "lastName": null,
						        "email": "contact@scottbyrns.com",
						        "password": "test"
						    },
						    "overview": "test"
						}});
					},
					"show list for user": function (message) {
						this.say(localStorage.userid, "get list for user");
					}
				},
				reactions: {
					"here is the current users nodary list": function (message) {
						// console.log(message);
						for (var i = 0; i < message.length; i += 1) {
							// console.log(message[i].name.value);
						}
					}
				}
			});

			LiveWidgets.addWidget({
				name:"record-list",
				properties: {
					list: "asdf",
					data: {}
				},
				constructor: function () {
					this.sendMessage(localStorage.userid, "get list for user");
				},
				template: "						<? if (data) { for (var record = 0; record < data.length; record += 1) {  ?>										<li>								<?=data[record].name.value ?>							</li>						<? } } ?>",
				behaviors: {

				},
				reactions: {
					"search results": function (message) {
						this.model.data = message;
						this.element.innerHTML = JSON.toTable(message, "Search", this.model.group, ["id", "password"]);;	
						// alert(this.template);
						// this.renderTemplate();
						// this.element.innerHTML = JSON.stringify(message);
					},
					"here is the current users nodary list": function (message) {
						// this.element.innerHTML = JSON.stringify(message);
						this.model.data = message;
						this.element.innerHTML = JSON.toTable(message, "Nodary", this.model.group, ["id", "password", "session", "sessionId"]);
						
						// for (var record = 0; record < message.length; record += 1) { 	
						// 	this.element.innerHTML += JSON.toTable(message[record], "Nodary");
						// }

						// alert(this.template);
						// this.renderTemplate();

					}
				}
			});
			
			LiveWidgets.addWidget({
				name:"settings-manager",
				properties:{
					title: "Settings Manager"
				},
				reactions: {
					"here are the settings you requested": function (message) {
						
						this.model.data = message;
						this.element.innerHTML = "<p>" + JSON.stringify(this.model.data) + "</p>";
						
					}
				}
			})
			
			$handle("jenkins").with(function () {
				console.log(arguments);
			});
			
			LiveWidgets.addWidget({
				name: "three-surface",
				properties: {
					key:"value"
				},
				constructor: function () {
					this.element.style.display="none";
					this.properties.scene = new THREE.Scene();
					this.properties.camera = new THREE.PerspectiveCamera( 975, window.innerWidth / window.innerHeight, 0.1, 1000 );

					this.properties.renderer = new THREE.WebGLRenderer();
					this.properties.renderer.setSize( window.innerWidth, window.innerHeight );
					this.element.appendChild( this.properties.renderer.domElement );
					
					this.properties.geometry = new THREE.CubeGeometry(1,1,1);
					this.properties.material = new THREE.MeshBasicMaterial( { color: 0x00ff00 } );
					this.properties.cube = new THREE.Mesh( this.properties.geometry, this.properties.material );
					this.properties.scene.add( this.properties.cube );

					this.properties.camera.position.z = 5;
					
					this.properties.renderer.render(this.properties.scene, this.properties.camera);
					
					this.properties.data = {"centerPoint":{"latitude":43.616783142089844,"longitude":43.616783142089844,"elevation":415.9057006835938},"meterRatio":1.0,"locationList":[{"latitude":43.61857986450195,"longitude":43.61857986450195,"elevation":413.0832214355469},{"latitude":43.61866760253906,"longitude":43.61866760253906,"elevation":413.0366821289062},{"latitude":43.61885070800781,"longitude":43.61885070800781,"elevation":412.6349487304688},{"latitude":43.61893844604492,"longitude":43.61893844604492,"elevation":412.2799682617188}]};
					
					this.properties.points = [];
					window.$$three = this;
					var minX = 999999999999, minY = 999999999999;
					
					var convertLocationToMercator = function (location) {
						console.log("convert WGS84 location to Mercator");

						var lat = location.latitude;
						var lon = location.longitude;

					  var x = lon * 20037508.34 / 180;
					  var y = Math.log(Math.tan((90 + lat) * Math.PI / 360)) / (Math.PI / 180);
					  y = y * 20037508.34 / 180;
					  var out = {
						  x:x,
						  y:y
					  };
					  return out;
					 };
					
					for (var location = 0; location < this.properties.data.locationList.length; location += 1) {
						// if (this.properties.data.locationsList.hasOwnProperty(location)) {
							var point = convertLocationToMercator(this.properties.data.locationList[location]);

							if (point.x < minX) {
								minX = point.x;
							}
							
							if (point.y < minY) {
								minY = point.y;
							}
							
							point.z = this.properties.data.locationList[location].elevation;
							this.properties.points.push(point);
						// }
					}
					
					this.properties.originOffset = {
						x:minX,
						y:minY
					};
					

										
										
					
					
					

					
					
					for (var point = 0; point < this.properties.points.length; point += 1) {
						var cpoint = this.properties.points[point];
						cpoint.x -= this.properties.originOffset.x;
						cpoint.y -= this.properties.originOffset.y;
						
						this.properties.points[point] = cpoint;
						var geometry = new THREE.CubeGeometry(4,4,1);
						var mesh = new THREE.Mesh( geometry, this.properties.material );
						mesh.translateX(cpoint.x);
						mesh.translateY(cpoint.y);
						// mesh.translateZ(cpoint.z);
						this.properties.scene.add( mesh );
						
						console.log(cpoint.x + " : " + cpoint.y);

					}
					this.properties.camera.position.z = 45;
					
					this.properties.renderer.render(this.properties.scene, this.properties.camera);

					
					
					
					window.$$three = this;
					
				},
				behaviors: {
					"look at an object": function (message) {
						// Implement camera look at message.target
					},
					"convert WGS84 location to Mercator": function (location) {
						console.log("convert WGS84 location to Mercator");

						var lat = location.latitude;
						var lon = location.longitude;

					  var x = lon * 20037508.34 / 180;
					  var y = Math.log(Math.tan((90 + lat) * Math.PI / 360)) / (Math.PI / 180);
					  y = y * 20037508.34 / 180;
					  var out = {
						  x:x,
						  y:y
					  };
					  return out;
					 },
					 "convert Mercator loction into WGS84 location": function (x, y) {
					  var lon = (x / 20037508.34) * 180;
					  var lat = (y / 20037508.34) * 180;

					  lat = 180/Math.PI * (2 * Math.atan(Math.exp(lat * Math.PI / 180)) - Math.PI / 2);

					  return [lon, lat];
					  }
				},
				reactions: {
					
				}
			});
			
			
			LiveWidgets.addWidget({
				name: "collaborate",
				properties: {
					existing: {},
					proto: {"id":"a0cc3cd8-e1bf-459f-bcfd-390b44ad998e","name":{"id":"caccaec0-2030-4c30-a76f-1be226dd5f01","value":"Nodary","name":null},"parentModel":null,"properties":[{"id":"c5790c8a-764b-41a7-bafb-b41129fd99c7","name":{"id":"29ae81be-3681-4f33-83db-30125ba6367a","value":"author","name":null},"type":{"id":"e0dad6ca-87ba-4bba-a618-dd55d0e675f8","name":{"id":"cfea9023-8867-4b12-8ef6-23e600f938e0","value":"Person","name":null},"parentModel":null,"properties":null,"superTypes":null},"variable":{"id":"399bd1b3-4d4a-4b7d-b08c-7ba77fd78850","name":"author","entityInstance":null}},{"id":"a3b6c9b9-b47c-43d4-b4f7-aa6e52a8575f","name":{"id":"7483092b-23e0-486c-918f-347b4ec188c2","value":"overview","name":null},"type":{"id":"9e695494-7d2d-4811-99aa-3cbd59f9d575","name":{"id":"9409fb61-9bfb-4eb7-9dcd-df84199d1d4f","value":"String","name":null},"parentModel":null,"properties":null,"superTypes":null},"variable":{"id":"8217c2dd-db49-4f3c-ab6a-4c0cec838141","name":"overview","entityInstance":null}},{"id":"d8f7784c-bace-4cae-8cad-ebc270859930","name":{"id":"48d23754-f6cb-4973-8a89-973aed08241d","value":"name","name":null},"type":{"id":"2970a515-0a91-4479-9763-9958e40ef5ed","name":{"id":"841e457a-7702-4a6d-8a56-7f65964194b6","value":"Label","name":null},"parentModel":null,"properties":[{"id":null,"name":{"id":"bf73623a-f32c-4721-b726-f24dd5e2fcad","value":"id","name":null},"type":{"id":null,"name":{"id":"08748ec8-a915-49b0-8fe8-02b37852b864","value":"String","name":null},"parentModel":null,"properties":null,"superTypes":null},"variable":{"id":null,"name":"id","entityInstance":null}},{"id":null,"name":{"id":"3cc63bb5-b54e-4002-9b07-0613de09e285","value":"value","name":null},"type":{"id":null,"name":{"id":"dbcdc1c2-4797-4464-94cc-28f1e95003cb","value":"String","name":null},"parentModel":null,"properties":null,"superTypes":null},"variable":{"id":null,"name":"value","entityInstance":null}}],"superTypes":null},"variable":{"id":"19107cf7-b583-4cd2-a3e5-d09f2c566565","name":"name","entityInstance":null}}]}
				},
				constructor: function () {
		
					var uml = Joint.dia.uml;
					this.properties.joint = Joint.paper(this.element, 800, 1200);
					$(this.element).bind("mousedown", function () {
						this.mousedown = true;
					}.bind(this));

					$(this.element).bind("mouseup", function () {
						this.mousedown = false;
					}.bind(this));

					$(this.element).bind("mousemove", function () {
						var lstTime = 0;
						setTimeout(function () {
							if (!(new Date() - lstTime > 100)) {
								return;
							}
							lstTime = new Date();
							if (!this.mousedown) {
								return;
							}
							this.sendToken = this.sendToken || Math.random();
							this.sendMessage("do broadcast state", "do broadcast state");
							// this.behaviors["do broadcast state"].call(this);
						}.bind(this), 0);					
}.bind(this));

					
					var uml = Joint.dia.uml;
					
					// var method = [];
					// 
					// for (var i = 0; i < this.model.proto.properties.length; i += 1) {
					// 	method.push("(" + this.model.proto.properties[i].type.name.value + ") : " + this.model.proto.properties[i].name.value);
					// }
					// 
					// uml.Class.create({
					// 	label: this.model.proto.name.value,
					// 	methods: method
					// });
					
					var steps = 0;
					
					var proccess = function (model) {
						var method = [];
						try {
							var children = [];
							try {
								for (var i = 0; i < model.properties.length; i += 1) {
									method.push("(" + model.properties[i].type.name.value + ") : " + model.properties[i].name.value);
								}
							}
							catch (ignore) {}
						
							this.model.existing[model.name.value] = this.model.existing[model.name.value] || Joint.dia.uml.Class.create({
							  rect: {x: 130 * (steps++), y: Math.random() * 200, width: 130, height: 100},
							  shadow: true,
							  attrs: {
							//    fill: "90-#000-green:1-#fff"
							    fill: "green"
							  },
							  labelAttrs: {
							    'font-weight': 'bold'
							  },
								label: model.name.value,
								attributes: method
							});
							
							children.push(this.model.existing[model.name.value]);
							
							for (var i = 0; i < model.properties.length; i += 1) {
								try {
									proccess(model.properties[i].type);
									children.push(this.model.existing[model.properties[i].type.name.value]);
								}
								catch (ignore) {}
							}

							

							
							for (var i = 0; i < children.length; i += 1) {
								if (children[i] == this.model.existing[model.name.value]) {
									continue;
								}
								// console.log(children[i]);
								children[i].joint(
									this.model.existing[model.name.value],
									Joint.dia.uml.aggregationArrow
								).register(children);
								
							}
						}
						catch (ignore) {
							console.error(ignore);
						}
					}.bind(this)
					console.log(this.properties.proto);
					proccess(this.properties.proto);
					// 	
					// for (var i = 0; i < this.model.data.length; i += 1) {
					// 	var clazz = this.model.data[i];
					// 	if (!this.model.existing[clazz.label]) {
					// 
					// 		this.model.existing[clazz.label] = uml.Class.create(clazz);
					// 		
					// 	}
					// 	else {
					// 
					// 	}
					// 
					// }
				},
				behaviors: {
					"build class and add to scene": function (message) {
						// var uml = Joint.dia.uml;
						// var clazz = uml.Class.create(message);
					},
					"render classes": function () {
						// alert("test2");
						// for (var i = 0; i < this.model.data.length; i += 1) {
						// 	var clazz = this.model.data[i];
						// 	this.broadcastMessage(clazz, "build class and add to scene");
						// }
					},
					"add entity to diagram": function () {
						// TODO implement dialog to create a new entity.
					},
					"do broadcast state": function (message) {

						var state = [];
						for (var element in this.model.existing) {
							if (this.model.existing.hasOwnProperty(element)) {
								try {
									var clazz = this.model.existing[element];
									try {
										if (null == clazz) { 
											continue;
										}
										

										var el = clazz.getAttributesElement();
										var dst = {
											x: el.attrs.x || 0,
											y: el.attrs.y || 0
										}
										
										el.remove();


										try {
											if (clazz && clazz.properties) {
												clazz.properties.offset = {};
												clazz.properties.offset.x = dst.x;
												clazz.properties.offset.y = dst.y;	
												clazz.properties.sender = this.sendToken;
											}
										}
										catch (e) {
											console.warn(e);
										}
										
										
									}
									catch (ignore){
										console.error(ignore);
									}
									
									state.push(clazz.properties);
									console.log("State added.");
									
								}
								catch (e) {
									console.warn(e);
								}
							}
						}
						console.log("Message sending");
						console.log(state);
						
						this.sendMessage(state, "sync clients");
					},
					"update state": function (message) {
						if (message == this.model.last) {
							return;
						}

						this.model.last = message;
						try {
							console.log(message)
							this.model.data = message;
							// this.model.existing = {};
							// this.model.joint.clear();
							// for (var element in this.model.existing) {
							// 	// var clazz = this.model.existing[element];
							// 	// clazz.remove();
							// 	delete this.model.existing[element];
							// }

							// var uml = Joint.dia.uml;


							for (var i = 0; i < message.length; i += 1) {
								
								var clazz = message[i];
								
								if (!this.model.existing[clazz.label]) {

									this.model.existing[clazz.label] = Joint.dia.uml.Class.create(clazz);

								}
								else {
									// console.log("Translating element");
									// if (null == clazz.rect.x) { clazz.rect.x = 0; }
									// if (null == clazz.rect.y) { clazz.rect.y = 0; }
									// this.model.existing[clazz.label].attr("x", clazz.rect.x);
									// this.model.existing[clazz.label].attr("y", clazz.rect.y);
									if (clazz.sender == this.sendToken) {
										return;
									}
									var el = this.model.existing[clazz.label].getAttributesElement();
									this.model.existing[clazz.label].translate(
										clazz.offset.x - el.attrs.x,
										clazz.offset.y - el.attrs.y
									);
									
									el.remove();
									// this.model.existing[clazz.label].translate(clazz.rect.x + (-this.model.existing[clazz.label].origBBox.x), clazz.rect.y + (-this.model.existing[clazz.label].origBBox.y));
									// window.b = window.b || clazz;
									// window.a = window.a || this.model.existing[clazz.label];
									// window.paper = this.model;
								}

							}
						}
						catch (e) {
							console.error(e);
						}
					}
				},
				reactions: {
					// "update state": "do update state",
					"create class": "build class and add to scene",
					"broadcast state": "do broadcast state",
					"user did would like to add an entity to the diagram": "add entity to diagram"
				}
				
			});
			
			LiveWidgets.addWidget({
				name:"json-form",
				properties: {
					title: "JSON Form"
				},
				constructor: function () {
					try {
						var element = this.element.getElementsByTagName("code")[0];
						if (element) {
							// alert(element);
						}
						var data = element.innerHTML;
						// alert(data);
						data = JSON.parse(data);
						// alert(data);
						// console.log(data);
						if (data) {
							this.element.innerHTML = JSON.toForm(data, this.properties.entity, this.model.group, ["id", "password"]);
						}
					}
					catch (e) {
						console.warn(e);
					}

				},
				controller: {
					handleMessage: function () {
						console.log(arguments);
					}
				},
				behaviors: {

				},
				reactions: {
					"here is the current users nodary list": function (message) {
						// console.log(message);
						for (var i = 0; i < message.length; i += 1) {
							// console.log(message[i].name.value);
						}
					}
				}
			});
			
			LiveWidgets.addWidget({
				name: "master-dialog",
				properties: {
					message: ""
				},
				constructor: function () {
					$(this.element).hide();					
				},
				behaviors: {
					"hide dialog": function () {
						$(this.element).hide();
					},
					"show dialog": function (message) {
						$("h3", this.element).html(message.title);
						$("p", this.element).html(message.message);
						$("div", this.element).html(message.controls);
					}
				},
				reactions: {
					"widget did render": "hide dialog",
					"please show the dialog": "show dialog"
				}
			})
			

			
			window.LiveActivities = function () {
				var LiveActivities = function () {
					this.activities = [];
				};
			
				var Helpers = {
				
				};
			
				var LiveActivity = function (activityModel) {
				
				};
				
				return new LiveActivities();
			}();
			
			var Activity = {
				scenes: [
				{
					name: "My Account",
					actions: {
						// Call to action
						"Save Changes": {
							// Widget
							actor: "update-user-account-form",
							// Channel
							behavior: "upate user account"
						}
					}					
				}
				]
			};
			
			
							
		});
		

		
		
		</script>
		
		<section data-widget="three-surface" style="position:absolute;left:0;top:0;z-index:100000"></section>
		<!-- <section data-widget="voice-input" data-group="voice"></section> -->



</body>
</html>
